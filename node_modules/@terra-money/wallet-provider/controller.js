import { WebExtensionTxStatus, } from '@terra-dev/web-extension-interface';
import { AccAddress, PublicKey, Tx, } from '@terra-money/terra.js';
import { ConnectType, WalletStatus, } from '@terra-money/use-wallet';
import deepEqual from 'fast-deep-equal';
import { BehaviorSubject } from 'rxjs';
import { filter, map } from 'rxjs/operators';
import { CHROME_EXTENSION_INSTALL_URL, DEFAULT_CHROME_EXTENSION_COMPATIBLE_BROWSER_CHECK, } from './env';
import { mapExtensionSignBytesError, mapExtensionTxError, } from './exception/mapExtensionTxError';
import { mapWalletConnectError } from './exception/mapWalletConnectError';
import { ExtensionRouter, ExtensionRouterStatus, } from './modules/extension-router';
import { getTerraExtensions, } from './modules/extension-router/multiChannel';
import { connect as reConnect, connectIfSessionExists as reConnectIfSessionExists, readonlyWalletModal, } from './modules/readonly-wallet';
import { connect as wcConnect, connectIfSessionExists as wcConnectIfSessionExists, WalletConnectSessionStatus, } from './modules/walletconnect';
import { isDesktopChrome } from './utils/browser-check';
import { checkExtensionReady } from './utils/checkExtensionReady';
const CONNECTIONS = {
    [ConnectType.READONLY]: {
        type: ConnectType.READONLY,
        name: 'View an address',
        icon: 'https://assets.terra.money/icon/station-extension/icon.png',
    },
    [ConnectType.WALLETCONNECT]: {
        type: ConnectType.WALLETCONNECT,
        name: 'Terra Station Mobile',
        icon: 'https://assets.terra.money/icon/station-extension/icon.png',
    },
};
const DEFAULT_WAITING_CHROME_EXTENSION_INSTALL_CHECK = 1000 * 3;
const WALLETCONNECT_SUPPORT_FEATURES = new Set([
    'post',
]);
const EMPTY_SUPPORT_FEATURES = new Set();
export class WalletController {
    constructor(options) {
        var _a;
        this.options = options;
        this.extension = null;
        this.walletConnect = null;
        this.readonlyWallet = null;
        this.disableReadonlyWallet = null;
        this.disableExtension = null;
        this.disableWalletConnect = null;
        /** @see Wallet#isChromeExtensionCompatibleBrowser */
        this.isChromeExtensionCompatibleBrowser = () => {
            var _a;
            return ((_a = this.options.dangerously__chromeExtensionCompatibleBrowserCheck) !== null && _a !== void 0 ? _a : DEFAULT_CHROME_EXTENSION_COMPATIBLE_BROWSER_CHECK)(navigator.userAgent);
        };
        /** @see Wallet#availableConnectTypes */
        this.availableConnectTypes = () => {
            return this._availableConnectTypes.asObservable();
        };
        /** @see Wallet#availableConnections */
        this.availableConnections = () => {
            return this._availableConnectTypes.pipe(map((connectTypes) => {
                const connections = [];
                for (const connectType of connectTypes) {
                    if (connectType === ConnectType.EXTENSION) {
                        const terraExtensions = getTerraExtensions();
                        for (const terraExtension of terraExtensions) {
                            connections.push({
                                type: ConnectType.EXTENSION,
                                identifier: terraExtension.identifier,
                                name: terraExtension.name,
                                icon: terraExtension.icon,
                            });
                        }
                    }
                    else {
                        connections.push(CONNECTIONS[connectType]);
                    }
                }
                return connections;
            }));
        };
        /** @see Wallet#availableInstallTypes */
        this.availableInstallTypes = () => {
            return this._availableInstallTypes.asObservable();
        };
        /**
         * @see Wallet#status
         * @see Wallet#network
         * @see Wallet#wallets
         */
        this.states = () => {
            return this._states.asObservable();
        };
        /** @see Wallet#recheckStatus */
        this.refetchStates = () => {
            var _a;
            if (this.disableExtension) {
                (_a = this.extension) === null || _a === void 0 ? void 0 : _a.refetchStates();
            }
        };
        /** @see Wallet#install */
        this.install = (type) => {
            if (type === ConnectType.EXTENSION) {
                // TODO separate install links by browser types
                window.open(CHROME_EXTENSION_INSTALL_URL, '_blank');
            }
            else {
                console.warn(`[WalletController] ConnectType "${type}" does not support install() function`);
            }
        };
        /** @see Wallet#connect */
        this.connect = (type, identifier) => {
            var _a, _b, _c;
            switch (type) {
                case ConnectType.READONLY:
                    const networks = Object.keys(this.options.walletConnectChainIds).map((chainId) => this.options.walletConnectChainIds[+chainId]);
                    const createReadonlyWalletSession = (_c = (_b = (_a = this.options).createReadonlyWalletSession) === null || _b === void 0 ? void 0 : _b.call(_a, networks)) !== null && _c !== void 0 ? _c : readonlyWalletModal({ networks });
                    createReadonlyWalletSession.then((readonlyWalletSession) => {
                        if (readonlyWalletSession) {
                            this.enableReadonlyWallet(reConnect(readonlyWalletSession));
                        }
                    });
                    break;
                case ConnectType.WALLETCONNECT:
                    this.enableWalletConnect(wcConnect(this.options));
                    break;
                case ConnectType.EXTENSION:
                    if (!this.extension) {
                        throw new Error(`extension instance is not created!`);
                    }
                    this.extension.connect(identifier);
                    this.enableExtension();
                    break;
                default:
                    throw new Error(`Unknown ConnectType!`);
            }
        };
        /** @see Wallet#connectReadonly */
        this.connectReadonly = (terraAddress, network) => {
            this.enableReadonlyWallet(reConnect({
                terraAddress,
                network,
            }));
        };
        /** @see Wallet#disconnect */
        this.disconnect = () => {
            var _a, _b, _c;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            this.disableReadonlyWallet = null;
            (_b = this.disableExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            this.disableExtension = null;
            (_c = this.disableWalletConnect) === null || _c === void 0 ? void 0 : _c.call(this);
            this.disableWalletConnect = null;
            this.updateStates(this._notConnected);
        };
        /**
         * @see Wallet#post
         * @param tx
         * @param terraAddress only available new extension
         */
        this.post = async (tx, terraAddress) => {
            // ---------------------------------------------
            // extension
            // ---------------------------------------------
            if (this.disableExtension) {
                return new Promise((resolve, reject) => {
                    if (!this.extension) {
                        reject(new Error(`extension instance not created!`));
                        return;
                    }
                    const subscription = this.extension.post(tx, terraAddress).subscribe({
                        next: (txResult) => {
                            if (txResult.status === WebExtensionTxStatus.SUCCEED) {
                                resolve({
                                    ...tx,
                                    result: txResult.payload,
                                    success: true,
                                });
                                subscription.unsubscribe();
                            }
                        },
                        error: (error) => {
                            reject(mapExtensionTxError(tx, error));
                            subscription.unsubscribe();
                        },
                    });
                });
            }
            // ---------------------------------------------
            // wallet connect
            // ---------------------------------------------
            else if (this.walletConnect) {
                return this.walletConnect
                    .post(tx)
                    .then((result) => ({
                    ...tx,
                    result,
                    success: true,
                }))
                    .catch((error) => {
                    throw mapWalletConnectError(tx, error);
                });
            }
            else {
                throw new Error(`There are no connections that can be posting tx!`);
            }
        };
        /**
         * @see Wallet#sign
         * @param tx
         * @param terraAddress only available new extension
         */
        this.sign = async (tx, terraAddress) => {
            if (this.disableExtension) {
                return new Promise((resolve, reject) => {
                    if (!this.extension) {
                        reject(new Error(`extension instance is not created!`));
                        return;
                    }
                    const subscription = this.extension.sign(tx, terraAddress).subscribe({
                        next: (txResult) => {
                            if (txResult.status === WebExtensionTxStatus.SUCCEED) {
                                resolve({
                                    ...tx,
                                    result: Tx.fromData(txResult.payload),
                                    success: true,
                                });
                                subscription.unsubscribe();
                            }
                        },
                        error: (error) => {
                            reject(mapExtensionTxError(tx, error));
                            subscription.unsubscribe();
                        },
                    });
                });
            }
            throw new Error(`sign() method only available on extension`);
        };
        /**
         * @see Wallet#signBytes
         * @param bytes
         * @param terraAddress only available new extension
         */
        this.signBytes = async (bytes, terraAddress) => {
            if (this.disableExtension) {
                return new Promise((resolve, reject) => {
                    if (!this.extension) {
                        reject(new Error(`extension instance is not created!`));
                        return;
                    }
                    const subscription = this.extension
                        .signBytes(bytes, terraAddress)
                        .subscribe({
                        next: (txResult) => {
                            if (txResult.status === WebExtensionTxStatus.SUCCEED) {
                                resolve({
                                    result: {
                                        recid: txResult.payload.recid,
                                        signature: Uint8Array.from(Buffer.from(txResult.payload.signature, 'base64')),
                                        public_key: txResult.payload.public_key
                                            ? PublicKey.fromData(txResult.payload.public_key)
                                            : undefined,
                                    },
                                    success: true,
                                });
                                subscription.unsubscribe();
                            }
                        },
                        error: (error) => {
                            reject(mapExtensionSignBytesError(bytes, error));
                            subscription.unsubscribe();
                        },
                    });
                });
            }
            throw new Error(`signBytes() method only available on extension`);
            // TODO implements signBytes() to other connect types
        };
        /**
         * @see Wallet#hasCW20Tokens
         * @param chainID
         * @param tokenAddrs Token addresses
         */
        this.hasCW20Tokens = async (chainID, ...tokenAddrs) => {
            if (this.availableExtensionFeature('cw20-token')) {
                return this.extension.hasCW20Tokens(chainID, ...tokenAddrs);
            }
            throw new Error(`Does not support hasCW20Tokens() on this connection`);
        };
        /**
         * @see Wallet#addCW20Tokens
         * @param chainID
         * @param tokenAddrs Token addresses
         */
        this.addCW20Tokens = async (chainID, ...tokenAddrs) => {
            if (this.availableExtensionFeature('cw20-token')) {
                return this.extension.addCW20Tokens(chainID, ...tokenAddrs);
            }
            throw new Error(`Does not support addCW20Tokens() on this connection`);
        };
        /**
         * @see Wallet#hasNetwork
         * @param network
         */
        this.hasNetwork = (network) => {
            if (this.availableExtensionFeature('network')) {
                return this.extension.hasNetwork(network);
            }
            throw new Error(`Does not support hasNetwork() on this connection`);
        };
        /**
         * @see Wallet#hasNetwork
         * @param network
         */
        this.addNetwork = (network) => {
            if (this.availableExtensionFeature('network')) {
                return this.extension.addNetwork(network);
            }
            throw new Error(`Does not support addNetwork() on this connection`);
        };
        // ================================================================
        // internal
        // connect type changing
        // ================================================================
        this.availableExtensionFeature = (feature) => {
            if (this.disableExtension && this.extension) {
                const states = this.extension.getLastStates();
                return (states.type === ExtensionRouterStatus.WALLET_CONNECTED &&
                    states.supportFeatures.has(feature));
            }
        };
        this.updateStates = (next) => {
            const prev = this._states.getValue();
            if (next.status === WalletStatus.WALLET_CONNECTED &&
                next.wallets.length === 0) {
                next = {
                    status: WalletStatus.WALLET_NOT_CONNECTED,
                    network: next.network,
                };
            }
            if (prev.status !== next.status || !deepEqual(prev, next)) {
                this._states.next(next);
            }
        };
        this.enableReadonlyWallet = (readonlyWallet) => {
            var _a, _b, _c;
            (_a = this.disableWalletConnect) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            if (this.readonlyWallet === readonlyWallet ||
                (((_c = this.readonlyWallet) === null || _c === void 0 ? void 0 : _c.terraAddress) === readonlyWallet.terraAddress &&
                    this.readonlyWallet.network === readonlyWallet.network)) {
                return;
            }
            if (this.readonlyWallet) {
                this.readonlyWallet.disconnect();
            }
            this.readonlyWallet = readonlyWallet;
            this.updateStates({
                status: WalletStatus.WALLET_CONNECTED,
                network: readonlyWallet.network,
                wallets: [
                    {
                        connectType: ConnectType.READONLY,
                        terraAddress: readonlyWallet.terraAddress,
                        design: 'readonly',
                    },
                ],
                supportFeatures: EMPTY_SUPPORT_FEATURES,
            });
            this.disableReadonlyWallet = () => {
                readonlyWallet.disconnect();
                this.readonlyWallet = null;
                this.disableReadonlyWallet = null;
            };
        };
        this.enableExtension = () => {
            var _a, _b;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableWalletConnect) === null || _b === void 0 ? void 0 : _b.call(this);
            if (this.disableExtension || !this.extension) {
                return;
            }
            const extensionSubscription = this.extension.states().subscribe({
                next: (extensionStates) => {
                    if (extensionStates.type === ExtensionRouterStatus.WALLET_CONNECTED &&
                        AccAddress.validate(extensionStates.wallet.terraAddress)) {
                        this.updateStates({
                            status: WalletStatus.WALLET_CONNECTED,
                            network: extensionStates.network,
                            wallets: [
                                {
                                    connectType: ConnectType.EXTENSION,
                                    terraAddress: extensionStates.wallet.terraAddress,
                                    design: extensionStates.wallet.design,
                                },
                            ],
                            supportFeatures: extensionStates.supportFeatures,
                        });
                    }
                    else {
                        this.updateStates(this._notConnected);
                    }
                },
            });
            this.disableExtension = () => {
                var _a;
                (_a = this.extension) === null || _a === void 0 ? void 0 : _a.disconnect();
                extensionSubscription.unsubscribe();
                this.disableExtension = null;
            };
        };
        this.enableWalletConnect = (walletConnect) => {
            var _a, _b;
            (_a = this.disableReadonlyWallet) === null || _a === void 0 ? void 0 : _a.call(this);
            (_b = this.disableExtension) === null || _b === void 0 ? void 0 : _b.call(this);
            if (this.walletConnect === walletConnect) {
                return;
            }
            if (this.walletConnect) {
                this.walletConnect.disconnect();
            }
            this.walletConnect = walletConnect;
            const subscribeWalletConnect = (wc) => {
                return wc.session().subscribe({
                    next: (status) => {
                        var _a;
                        switch (status.status) {
                            case WalletConnectSessionStatus.CONNECTED:
                                this.updateStates({
                                    status: WalletStatus.WALLET_CONNECTED,
                                    network: (_a = this.options.walletConnectChainIds[status.chainId]) !== null && _a !== void 0 ? _a : this.options.defaultNetwork,
                                    wallets: [
                                        {
                                            connectType: ConnectType.WALLETCONNECT,
                                            terraAddress: status.terraAddress,
                                            design: 'walletconnect',
                                        },
                                    ],
                                    supportFeatures: WALLETCONNECT_SUPPORT_FEATURES,
                                });
                                break;
                            default:
                                this.updateStates(this._notConnected);
                                break;
                        }
                    },
                });
            };
            const walletConnectSessionSubscription = subscribeWalletConnect(walletConnect);
            this.disableWalletConnect = () => {
                var _a;
                (_a = this.walletConnect) === null || _a === void 0 ? void 0 : _a.disconnect();
                this.walletConnect = null;
                walletConnectSessionSubscription.unsubscribe();
                this.disableWalletConnect = null;
            };
        };
        this._notConnected = {
            status: WalletStatus.WALLET_NOT_CONNECTED,
            network: options.defaultNetwork,
        };
        this._initializing = {
            status: WalletStatus.INITIALIZING,
            network: options.defaultNetwork,
        };
        this._availableConnectTypes = new BehaviorSubject([
            ConnectType.READONLY,
            ConnectType.WALLETCONNECT,
        ]);
        this._availableInstallTypes = new BehaviorSubject([]);
        this._states = new BehaviorSubject(this._initializing);
        let numSessionCheck = 0;
        // wait checking the availability of the chrome extension
        // 0. check if extension wallet session is exists
        checkExtensionReady((_a = options.waitingChromeExtensionInstallCheck) !== null && _a !== void 0 ? _a : DEFAULT_WAITING_CHROME_EXTENSION_INSTALL_CHECK, this.isChromeExtensionCompatibleBrowser()).then((ready) => {
            var _a;
            if (ready) {
                this._availableConnectTypes.next([
                    ConnectType.EXTENSION,
                    ConnectType.WALLETCONNECT,
                    ConnectType.READONLY,
                ]);
                this.extension = new ExtensionRouter({
                    hostWindow: window,
                    selectExtension: options.selectExtension,
                    dangerously__chromeExtensionCompatibleBrowserCheck: (_a = options.dangerously__chromeExtensionCompatibleBrowserCheck) !== null && _a !== void 0 ? _a : DEFAULT_CHROME_EXTENSION_COMPATIBLE_BROWSER_CHECK,
                    defaultNetwork: options.defaultNetwork,
                });
                const subscription = this.extension
                    .states()
                    .pipe(filter(({ type }) => type !== ExtensionRouterStatus.INITIALIZING))
                    .subscribe((extensionStates) => {
                    try {
                        subscription.unsubscribe();
                    }
                    catch (_a) { }
                    if (extensionStates.type === ExtensionRouterStatus.WALLET_CONNECTED &&
                        !this.disableWalletConnect &&
                        !this.disableReadonlyWallet) {
                        this.enableExtension();
                    }
                    else if (numSessionCheck === 0) {
                        numSessionCheck += 1;
                    }
                    else {
                        this.updateStates(this._notConnected);
                    }
                });
            }
            else {
                if (isDesktopChrome(this.isChromeExtensionCompatibleBrowser())) {
                    this._availableInstallTypes.next([ConnectType.EXTENSION]);
                }
                if (numSessionCheck === 0) {
                    numSessionCheck += 1;
                }
                else {
                    this.updateStates(this._notConnected);
                }
            }
        });
        // 1. check if readonly wallet session is exists
        const draftReadonlyWallet = reConnectIfSessionExists();
        if (draftReadonlyWallet) {
            this.enableReadonlyWallet(draftReadonlyWallet);
            return;
        }
        // 2. check if walletconnect sesison is exists
        const draftWalletConnect = wcConnectIfSessionExists(options);
        if (draftWalletConnect &&
            draftWalletConnect.getLatestSession().status ===
                WalletConnectSessionStatus.CONNECTED) {
            this.enableWalletConnect(draftWalletConnect);
        }
        else if (numSessionCheck === 0) {
            numSessionCheck += 1;
        }
        else {
            this.updateStates(this._notConnected);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9AdGVycmEtbW9uZXkvd2FsbGV0LXByb3ZpZGVyL2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLG9CQUFvQixHQUNyQixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFDTCxVQUFVLEVBRVYsU0FBUyxFQUNULEVBQUUsR0FDSCxNQUFNLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sRUFFTCxXQUFXLEVBTVgsWUFBWSxHQUNiLE1BQU0seUJBQXlCLENBQUM7QUFDakMsT0FBTyxTQUFTLE1BQU0saUJBQWlCLENBQUM7QUFDeEMsT0FBTyxFQUFFLGVBQWUsRUFBNEIsTUFBTSxNQUFNLENBQUM7QUFDakUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQ0wsNEJBQTRCLEVBQzVCLGlEQUFpRCxHQUNsRCxNQUFNLE9BQU8sQ0FBQztBQUNmLE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIsbUJBQW1CLEdBQ3BCLE1BQU0saUNBQWlDLENBQUM7QUFDekMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDMUUsT0FBTyxFQUNMLGVBQWUsRUFDZixxQkFBcUIsR0FDdEIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBRUwsa0JBQWtCLEdBQ25CLE1BQU0seUNBQXlDLENBQUM7QUFDakQsT0FBTyxFQUNMLE9BQU8sSUFBSSxTQUFTLEVBQ3BCLHNCQUFzQixJQUFJLHdCQUF3QixFQUVsRCxtQkFBbUIsR0FFcEIsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQ0wsT0FBTyxJQUFJLFNBQVMsRUFDcEIsc0JBQXNCLElBQUksd0JBQXdCLEVBR2xELDBCQUEwQixHQUMzQixNQUFNLHlCQUF5QixDQUFDO0FBQ2pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQWlGbEUsTUFBTSxXQUFXLEdBQUc7SUFDbEIsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDdEIsSUFBSSxFQUFFLFdBQVcsQ0FBQyxRQUFRO1FBQzFCLElBQUksRUFBRSxpQkFBaUI7UUFDdkIsSUFBSSxFQUFFLDREQUE0RDtLQUNyRDtJQUNmLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQzNCLElBQUksRUFBRSxXQUFXLENBQUMsYUFBYTtRQUMvQixJQUFJLEVBQUUsc0JBQXNCO1FBQzVCLElBQUksRUFBRSw0REFBNEQ7S0FDckQ7Q0FDUCxDQUFDO0FBRVgsTUFBTSw4Q0FBOEMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBQ2hFLE1BQU0sOEJBQThCLEdBQUcsSUFBSSxHQUFHLENBQTRCO0lBQ3hFLE1BQU07Q0FDUCxDQUFDLENBQUM7QUFDSCxNQUFNLHNCQUFzQixHQUFHLElBQUksR0FBRyxFQUE2QixDQUFDO0FBRXBFLE1BQU0sT0FBTyxnQkFBZ0I7SUFnQjNCLFlBQXFCLE9BQWdDOztRQUFoQyxZQUFPLEdBQVAsT0FBTyxDQUF5QjtRQWY3QyxjQUFTLEdBQTJCLElBQUksQ0FBQztRQUN6QyxrQkFBYSxHQUFtQyxJQUFJLENBQUM7UUFDckQsbUJBQWMsR0FBb0MsSUFBSSxDQUFDO1FBTXZELDBCQUFxQixHQUF3QixJQUFJLENBQUM7UUFDbEQscUJBQWdCLEdBQXdCLElBQUksQ0FBQztRQUM3Qyx5QkFBb0IsR0FBd0IsSUFBSSxDQUFDO1FBNkd6RCxxREFBcUQ7UUFDckQsdUNBQWtDLEdBQUcsR0FBWSxFQUFFOztZQUNqRCxPQUFPLENBQ0wsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLGtEQUFrRCxtQ0FDL0QsaURBQWlELENBQ2xELENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQztRQUVGLHdDQUF3QztRQUN4QywwQkFBcUIsR0FBRyxHQUE4QixFQUFFO1lBQ3RELE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3BELENBQUMsQ0FBQztRQUVGLHVDQUF1QztRQUN2Qyx5QkFBb0IsR0FBRyxHQUE2QixFQUFFO1lBQ3BELE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FDckMsR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQ25CLE1BQU0sV0FBVyxHQUFpQixFQUFFLENBQUM7Z0JBRXJDLEtBQUssTUFBTSxXQUFXLElBQUksWUFBWSxFQUFFO29CQUN0QyxJQUFJLFdBQVcsS0FBSyxXQUFXLENBQUMsU0FBUyxFQUFFO3dCQUN6QyxNQUFNLGVBQWUsR0FBRyxrQkFBa0IsRUFBRSxDQUFDO3dCQUU3QyxLQUFLLE1BQU0sY0FBYyxJQUFJLGVBQWUsRUFBRTs0QkFDNUMsV0FBVyxDQUFDLElBQUksQ0FBQztnQ0FDZixJQUFJLEVBQUUsV0FBVyxDQUFDLFNBQVM7Z0NBQzNCLFVBQVUsRUFBRSxjQUFjLENBQUMsVUFBVTtnQ0FDckMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxJQUFJO2dDQUN6QixJQUFJLEVBQUUsY0FBYyxDQUFDLElBQUk7NkJBQzFCLENBQUMsQ0FBQzt5QkFDSjtxQkFDRjt5QkFBTTt3QkFDTCxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO3FCQUM1QztpQkFDRjtnQkFFRCxPQUFPLFdBQVcsQ0FBQztZQUNyQixDQUFDLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRUYsd0NBQXdDO1FBQ3hDLDBCQUFxQixHQUFHLEdBQThCLEVBQUU7WUFDdEQsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEQsQ0FBQyxDQUFDO1FBRUY7Ozs7V0FJRztRQUNILFdBQU0sR0FBRyxHQUE2QixFQUFFO1lBQ3RDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNyQyxDQUFDLENBQUM7UUFFRixnQ0FBZ0M7UUFDaEMsa0JBQWEsR0FBRyxHQUFHLEVBQUU7O1lBQ25CLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6QixNQUFBLElBQUksQ0FBQyxTQUFTLDBDQUFFLGFBQWEsRUFBRSxDQUFDO2FBQ2pDO1FBQ0gsQ0FBQyxDQUFDO1FBRUYsMEJBQTBCO1FBQzFCLFlBQU8sR0FBRyxDQUFDLElBQWlCLEVBQUUsRUFBRTtZQUM5QixJQUFJLElBQUksS0FBSyxXQUFXLENBQUMsU0FBUyxFQUFFO2dCQUNsQywrQ0FBK0M7Z0JBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDckQ7aUJBQU07Z0JBQ0wsT0FBTyxDQUFDLElBQUksQ0FDVixtQ0FBbUMsSUFBSSx1Q0FBdUMsQ0FDL0UsQ0FBQzthQUNIO1FBQ0gsQ0FBQyxDQUFDO1FBRUYsMEJBQTBCO1FBQzFCLFlBQU8sR0FBRyxDQUFDLElBQWlCLEVBQUUsVUFBbUIsRUFBRSxFQUFFOztZQUNuRCxRQUFRLElBQUksRUFBRTtnQkFDWixLQUFLLFdBQVcsQ0FBQyxRQUFRO29CQUN2QixNQUFNLFFBQVEsR0FBa0IsTUFBTSxDQUFDLElBQUksQ0FDekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsQ0FDbkMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO29CQUVqRSxNQUFNLDJCQUEyQixHQUMvQixNQUFBLE1BQUEsTUFBQSxJQUFJLENBQUMsT0FBTyxFQUFDLDJCQUEyQixtREFBRyxRQUFRLENBQUMsbUNBQ3BELG1CQUFtQixDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztvQkFFcEMsMkJBQTJCLENBQUMsSUFBSSxDQUFDLENBQUMscUJBQXFCLEVBQUUsRUFBRTt3QkFDekQsSUFBSSxxQkFBcUIsRUFBRTs0QkFDekIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7eUJBQzdEO29CQUNILENBQUMsQ0FBQyxDQUFDO29CQUNILE1BQU07Z0JBQ1IsS0FBSyxXQUFXLENBQUMsYUFBYTtvQkFDNUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztvQkFDbEQsTUFBTTtnQkFDUixLQUFLLFdBQVcsQ0FBQyxTQUFTO29CQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTt3QkFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO3FCQUN2RDtvQkFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDbkMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUN2QixNQUFNO2dCQUNSO29CQUNFLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQzthQUMzQztRQUNILENBQUMsQ0FBQztRQUVGLGtDQUFrQztRQUNsQyxvQkFBZSxHQUFHLENBQUMsWUFBb0IsRUFBRSxPQUFvQixFQUFFLEVBQUU7WUFDL0QsSUFBSSxDQUFDLG9CQUFvQixDQUN2QixTQUFTLENBQUM7Z0JBQ1IsWUFBWTtnQkFDWixPQUFPO2FBQ1IsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUM7UUFFRiw2QkFBNkI7UUFDN0IsZUFBVSxHQUFHLEdBQUcsRUFBRTs7WUFDaEIsTUFBQSxJQUFJLENBQUMscUJBQXFCLCtDQUExQixJQUFJLENBQTBCLENBQUM7WUFDL0IsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQztZQUVsQyxNQUFBLElBQUksQ0FBQyxnQkFBZ0IsK0NBQXJCLElBQUksQ0FBcUIsQ0FBQztZQUMxQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1lBRTdCLE1BQUEsSUFBSSxDQUFDLG9CQUFvQiwrQ0FBekIsSUFBSSxDQUF5QixDQUFDO1lBQzlCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUM7WUFFakMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDO1FBRUY7Ozs7V0FJRztRQUNILFNBQUksR0FBRyxLQUFLLEVBQ1YsRUFBbUIsRUFDbkIsWUFBcUIsRUFDRixFQUFFO1lBQ3JCLGdEQUFnRDtZQUNoRCxZQUFZO1lBQ1osZ0RBQWdEO1lBQ2hELElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6QixPQUFPLElBQUksT0FBTyxDQUFXLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO29CQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTt3QkFDbkIsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUMsQ0FBQzt3QkFDckQsT0FBTztxQkFDUjtvQkFFRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLENBQUMsU0FBUyxDQUFDO3dCQUNuRSxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRTs0QkFDakIsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLG9CQUFvQixDQUFDLE9BQU8sRUFBRTtnQ0FDcEQsT0FBTyxDQUFDO29DQUNOLEdBQUcsRUFBRTtvQ0FDTCxNQUFNLEVBQUUsUUFBUSxDQUFDLE9BQU87b0NBQ3hCLE9BQU8sRUFBRSxJQUFJO2lDQUNkLENBQUMsQ0FBQztnQ0FDSCxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7NkJBQzVCO3dCQUNILENBQUM7d0JBQ0QsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7NEJBQ2YsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDOzRCQUN2QyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7d0JBQzdCLENBQUM7cUJBQ0YsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxnREFBZ0Q7WUFDaEQsaUJBQWlCO1lBQ2pCLGdEQUFnRDtpQkFDM0MsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO2dCQUMzQixPQUFPLElBQUksQ0FBQyxhQUFhO3FCQUN0QixJQUFJLENBQUMsRUFBRSxDQUFDO3FCQUNSLElBQUksQ0FDSCxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ1QsQ0FBQztvQkFDQyxHQUFHLEVBQUU7b0JBQ0wsTUFBTTtvQkFDTixPQUFPLEVBQUUsSUFBSTtpQkFDRCxDQUFBLENBQ2pCO3FCQUNBLEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUNmLE1BQU0scUJBQXFCLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUN6QyxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQzthQUNyRTtRQUNILENBQUMsQ0FBQztRQUVGOzs7O1dBSUc7UUFDSCxTQUFJLEdBQUcsS0FBSyxFQUNWLEVBQW1CLEVBQ25CLFlBQXFCLEVBQ0EsRUFBRTtZQUN2QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDekIsT0FBTyxJQUFJLE9BQU8sQ0FBYSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtvQkFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7d0JBQ25CLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDLENBQUM7d0JBQ3hELE9BQU87cUJBQ1I7b0JBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQzt3QkFDbkUsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUU7NEJBQ2pCLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUU7Z0NBQ3BELE9BQU8sQ0FBQztvQ0FDTixHQUFHLEVBQUU7b0NBQ0wsTUFBTSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztvQ0FDckMsT0FBTyxFQUFFLElBQUk7aUNBQ2QsQ0FBQyxDQUFDO2dDQUNILFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQzs2QkFDNUI7d0JBQ0gsQ0FBQzt3QkFDRCxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTs0QkFDZixNQUFNLENBQUMsbUJBQW1CLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7NEJBQ3ZDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQzt3QkFDN0IsQ0FBQztxQkFDRixDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7YUFDSjtZQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsMkNBQTJDLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUM7UUFFRjs7OztXQUlHO1FBQ0gsY0FBUyxHQUFHLEtBQUssRUFDZixLQUFhLEVBQ2IsWUFBcUIsRUFDSyxFQUFFO1lBQzVCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6QixPQUFPLElBQUksT0FBTyxDQUFrQixDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtvQkFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7d0JBQ25CLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDLENBQUM7d0JBQ3hELE9BQU87cUJBQ1I7b0JBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVM7eUJBQ2hDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDO3lCQUM5QixTQUFTLENBQUM7d0JBQ1QsSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEVBQUU7NEJBQ2pCLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUU7Z0NBQ3BELE9BQU8sQ0FBQztvQ0FDTixNQUFNLEVBQUU7d0NBQ04sS0FBSyxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSzt3Q0FDN0IsU0FBUyxFQUFFLFVBQVUsQ0FBQyxJQUFJLENBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQ2xEO3dDQUNELFVBQVUsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVU7NENBQ3JDLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDOzRDQUNqRCxDQUFDLENBQUMsU0FBUztxQ0FDZDtvQ0FDRCxPQUFPLEVBQUUsSUFBSTtpQ0FDZCxDQUFDLENBQUM7Z0NBQ0gsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDOzZCQUM1Qjt3QkFDSCxDQUFDO3dCQUNELEtBQUssRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFOzRCQUNmLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQzs0QkFDakQsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO3dCQUM3QixDQUFDO3FCQUNGLENBQUMsQ0FBQztnQkFDUCxDQUFDLENBQUMsQ0FBQzthQUNKO1lBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO1lBQ2xFLHFEQUFxRDtRQUN2RCxDQUFDLENBQUM7UUFFRjs7OztXQUlHO1FBQ0gsa0JBQWEsR0FBRyxLQUFLLEVBQ25CLE9BQWUsRUFDZixHQUFHLFVBQW9CLEVBQ29CLEVBQUU7WUFDN0MsSUFBSSxJQUFJLENBQUMseUJBQXlCLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQ2hELE9BQU8sSUFBSSxDQUFDLFNBQVUsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUM7YUFDOUQ7WUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7UUFDekUsQ0FBQyxDQUFDO1FBRUY7Ozs7V0FJRztRQUNILGtCQUFhLEdBQUcsS0FBSyxFQUNuQixPQUFlLEVBQ2YsR0FBRyxVQUFvQixFQUNvQixFQUFFO1lBQzdDLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUNoRCxPQUFPLElBQUksQ0FBQyxTQUFVLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxHQUFHLFVBQVUsQ0FBQyxDQUFDO2FBQzlEO1lBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1FBQ3pFLENBQUMsQ0FBQztRQUVGOzs7V0FHRztRQUNILGVBQVUsR0FBRyxDQUFDLE9BQWtDLEVBQW9CLEVBQUU7WUFDcEUsSUFBSSxJQUFJLENBQUMseUJBQXlCLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQzdDLE9BQU8sSUFBSSxDQUFDLFNBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDNUM7WUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7UUFDdEUsQ0FBQyxDQUFDO1FBRUY7OztXQUdHO1FBQ0gsZUFBVSxHQUFHLENBQUMsT0FBb0IsRUFBb0IsRUFBRTtZQUN0RCxJQUFJLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDN0MsT0FBTyxJQUFJLENBQUMsU0FBVSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM1QztZQUVELE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztRQUN0RSxDQUFDLENBQUM7UUFFRixtRUFBbUU7UUFDbkUsV0FBVztRQUNYLHdCQUF3QjtRQUN4QixtRUFBbUU7UUFDM0QsOEJBQXlCLEdBQUcsQ0FBQyxPQUFrQyxFQUFFLEVBQUU7WUFDekUsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDM0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFFOUMsT0FBTyxDQUNMLE1BQU0sQ0FBQyxJQUFJLEtBQUsscUJBQXFCLENBQUMsZ0JBQWdCO29CQUN0RCxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FDcEMsQ0FBQzthQUNIO1FBQ0gsQ0FBQyxDQUFDO1FBRU0saUJBQVksR0FBRyxDQUFDLElBQWtCLEVBQUUsRUFBRTtZQUM1QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRXJDLElBQ0UsSUFBSSxDQUFDLE1BQU0sS0FBSyxZQUFZLENBQUMsZ0JBQWdCO2dCQUM3QyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQ3pCO2dCQUNBLElBQUksR0FBRztvQkFDTCxNQUFNLEVBQUUsWUFBWSxDQUFDLG9CQUFvQjtvQkFDekMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2lCQUN0QixDQUFDO2FBQ0g7WUFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ3pELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3pCO1FBQ0gsQ0FBQyxDQUFDO1FBRU0seUJBQW9CLEdBQUcsQ0FBQyxjQUF3QyxFQUFFLEVBQUU7O1lBQzFFLE1BQUEsSUFBSSxDQUFDLG9CQUFvQiwrQ0FBekIsSUFBSSxDQUF5QixDQUFDO1lBQzlCLE1BQUEsSUFBSSxDQUFDLGdCQUFnQiwrQ0FBckIsSUFBSSxDQUFxQixDQUFDO1lBRTFCLElBQ0UsSUFBSSxDQUFDLGNBQWMsS0FBSyxjQUFjO2dCQUN0QyxDQUFDLENBQUEsTUFBQSxJQUFJLENBQUMsY0FBYywwQ0FBRSxZQUFZLE1BQUssY0FBYyxDQUFDLFlBQVk7b0JBQ2hFLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxLQUFLLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFDekQ7Z0JBQ0EsT0FBTzthQUNSO1lBRUQsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUN2QixJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsRUFBRSxDQUFDO2FBQ2xDO1lBRUQsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLENBQUM7WUFFckMsSUFBSSxDQUFDLFlBQVksQ0FBQztnQkFDaEIsTUFBTSxFQUFFLFlBQVksQ0FBQyxnQkFBZ0I7Z0JBQ3JDLE9BQU8sRUFBRSxjQUFjLENBQUMsT0FBTztnQkFDL0IsT0FBTyxFQUFFO29CQUNQO3dCQUNFLFdBQVcsRUFBRSxXQUFXLENBQUMsUUFBUTt3QkFDakMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxZQUFZO3dCQUN6QyxNQUFNLEVBQUUsVUFBVTtxQkFDbkI7aUJBQ0Y7Z0JBQ0QsZUFBZSxFQUFFLHNCQUFzQjthQUN4QyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMscUJBQXFCLEdBQUcsR0FBRyxFQUFFO2dCQUNoQyxjQUFjLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQzVCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO2dCQUMzQixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDO1lBQ3BDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUVNLG9CQUFlLEdBQUcsR0FBRyxFQUFFOztZQUM3QixNQUFBLElBQUksQ0FBQyxxQkFBcUIsK0NBQTFCLElBQUksQ0FBMEIsQ0FBQztZQUMvQixNQUFBLElBQUksQ0FBQyxvQkFBb0IsK0NBQXpCLElBQUksQ0FBeUIsQ0FBQztZQUU5QixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQzVDLE9BQU87YUFDUjtZQUVELE1BQU0scUJBQXFCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQzlELElBQUksRUFBRSxDQUFDLGVBQWUsRUFBRSxFQUFFO29CQUN4QixJQUNFLGVBQWUsQ0FBQyxJQUFJLEtBQUsscUJBQXFCLENBQUMsZ0JBQWdCO3dCQUMvRCxVQUFVLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQ3hEO3dCQUNBLElBQUksQ0FBQyxZQUFZLENBQUM7NEJBQ2hCLE1BQU0sRUFBRSxZQUFZLENBQUMsZ0JBQWdCOzRCQUNyQyxPQUFPLEVBQUUsZUFBZSxDQUFDLE9BQU87NEJBQ2hDLE9BQU8sRUFBRTtnQ0FDUDtvQ0FDRSxXQUFXLEVBQUUsV0FBVyxDQUFDLFNBQVM7b0NBQ2xDLFlBQVksRUFBRSxlQUFlLENBQUMsTUFBTSxDQUFDLFlBQVk7b0NBQ2pELE1BQU0sRUFBRSxlQUFlLENBQUMsTUFBTSxDQUFDLE1BQU07aUNBQ3RDOzZCQUNGOzRCQUNELGVBQWUsRUFBRSxlQUFlLENBQUMsZUFBZTt5QkFDakQsQ0FBQyxDQUFDO3FCQUNKO3lCQUFNO3dCQUNMLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO3FCQUN2QztnQkFDSCxDQUFDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEdBQUcsRUFBRTs7Z0JBQzNCLE1BQUEsSUFBSSxDQUFDLFNBQVMsMENBQUUsVUFBVSxFQUFFLENBQUM7Z0JBQzdCLHFCQUFxQixDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNwQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1lBQy9CLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUVNLHdCQUFtQixHQUFHLENBQUMsYUFBc0MsRUFBRSxFQUFFOztZQUN2RSxNQUFBLElBQUksQ0FBQyxxQkFBcUIsK0NBQTFCLElBQUksQ0FBMEIsQ0FBQztZQUMvQixNQUFBLElBQUksQ0FBQyxnQkFBZ0IsK0NBQXJCLElBQUksQ0FBcUIsQ0FBQztZQUUxQixJQUFJLElBQUksQ0FBQyxhQUFhLEtBQUssYUFBYSxFQUFFO2dCQUN4QyxPQUFPO2FBQ1I7WUFFRCxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLENBQUM7YUFDakM7WUFFRCxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztZQUVuQyxNQUFNLHNCQUFzQixHQUFHLENBQzdCLEVBQTJCLEVBQ2IsRUFBRTtnQkFDaEIsT0FBTyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDO29CQUM1QixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRTs7d0JBQ2YsUUFBUSxNQUFNLENBQUMsTUFBTSxFQUFFOzRCQUNyQixLQUFLLDBCQUEwQixDQUFDLFNBQVM7Z0NBQ3ZDLElBQUksQ0FBQyxZQUFZLENBQUM7b0NBQ2hCLE1BQU0sRUFBRSxZQUFZLENBQUMsZ0JBQWdCO29DQUNyQyxPQUFPLEVBQ0wsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUNBQ2xELElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYztvQ0FDN0IsT0FBTyxFQUFFO3dDQUNQOzRDQUNFLFdBQVcsRUFBRSxXQUFXLENBQUMsYUFBYTs0Q0FDdEMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZOzRDQUNqQyxNQUFNLEVBQUUsZUFBZTt5Q0FDeEI7cUNBQ0Y7b0NBQ0QsZUFBZSxFQUFFLDhCQUE4QjtpQ0FDaEQsQ0FBQyxDQUFDO2dDQUNILE1BQU07NEJBQ1I7Z0NBQ0UsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0NBQ3RDLE1BQU07eUJBQ1Q7b0JBQ0gsQ0FBQztpQkFDRixDQUFDLENBQUM7WUFDTCxDQUFDLENBQUM7WUFFRixNQUFNLGdDQUFnQyxHQUNwQyxzQkFBc0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUV4QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsR0FBRyxFQUFFOztnQkFDL0IsTUFBQSxJQUFJLENBQUMsYUFBYSwwQ0FBRSxVQUFVLEVBQUUsQ0FBQztnQkFDakMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7Z0JBQzFCLGdDQUFnQyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUMvQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO1lBQ25DLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQXRsQkEsSUFBSSxDQUFDLGFBQWEsR0FBRztZQUNuQixNQUFNLEVBQUUsWUFBWSxDQUFDLG9CQUFvQjtZQUN6QyxPQUFPLEVBQUUsT0FBTyxDQUFDLGNBQWM7U0FDaEMsQ0FBQztRQUVGLElBQUksQ0FBQyxhQUFhLEdBQUc7WUFDbkIsTUFBTSxFQUFFLFlBQVksQ0FBQyxZQUFZO1lBQ2pDLE9BQU8sRUFBRSxPQUFPLENBQUMsY0FBYztTQUNoQyxDQUFDO1FBRUYsSUFBSSxDQUFDLHNCQUFzQixHQUFHLElBQUksZUFBZSxDQUFnQjtZQUMvRCxXQUFXLENBQUMsUUFBUTtZQUNwQixXQUFXLENBQUMsYUFBYTtTQUMxQixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxlQUFlLENBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBRXJFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxlQUFlLENBQWUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXJFLElBQUksZUFBZSxHQUFXLENBQUMsQ0FBQztRQUVoQyx5REFBeUQ7UUFDekQsaURBQWlEO1FBQ2pELG1CQUFtQixDQUNqQixNQUFBLE9BQU8sQ0FBQyxrQ0FBa0MsbUNBQ3hDLDhDQUE4QyxFQUNoRCxJQUFJLENBQUMsa0NBQWtDLEVBQUUsQ0FDMUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFjLEVBQUUsRUFBRTs7WUFDeEIsSUFBSSxLQUFLLEVBQUU7Z0JBQ1QsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQztvQkFDL0IsV0FBVyxDQUFDLFNBQVM7b0JBQ3JCLFdBQVcsQ0FBQyxhQUFhO29CQUN6QixXQUFXLENBQUMsUUFBUTtpQkFDckIsQ0FBQyxDQUFDO2dCQUVILElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxlQUFlLENBQUM7b0JBQ25DLFVBQVUsRUFBRSxNQUFNO29CQUNsQixlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWU7b0JBQ3hDLGtEQUFrRCxFQUNoRCxNQUFBLE9BQU8sQ0FBQyxrREFBa0QsbUNBQzFELGlEQUFpRDtvQkFDbkQsY0FBYyxFQUFFLE9BQU8sQ0FBQyxjQUFjO2lCQUN2QyxDQUFDLENBQUM7Z0JBRUgsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVM7cUJBQ2hDLE1BQU0sRUFBRTtxQkFDUixJQUFJLENBQ0gsTUFBTSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxLQUFLLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUNsRTtxQkFDQSxTQUFTLENBQUMsQ0FBQyxlQUFlLEVBQUUsRUFBRTtvQkFDN0IsSUFBSTt3QkFDRixZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7cUJBQzVCO29CQUFDLFdBQU0sR0FBRTtvQkFFVixJQUNFLGVBQWUsQ0FBQyxJQUFJLEtBQUsscUJBQXFCLENBQUMsZ0JBQWdCO3dCQUMvRCxDQUFDLElBQUksQ0FBQyxvQkFBb0I7d0JBQzFCLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUMzQjt3QkFDQSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7cUJBQ3hCO3lCQUFNLElBQUksZUFBZSxLQUFLLENBQUMsRUFBRTt3QkFDaEMsZUFBZSxJQUFJLENBQUMsQ0FBQztxQkFDdEI7eUJBQU07d0JBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7cUJBQ3ZDO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0wsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLENBQUMsRUFBRTtvQkFDOUQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2lCQUMzRDtnQkFFRCxJQUFJLGVBQWUsS0FBSyxDQUFDLEVBQUU7b0JBQ3pCLGVBQWUsSUFBSSxDQUFDLENBQUM7aUJBQ3RCO3FCQUFNO29CQUNMLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2lCQUN2QzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxnREFBZ0Q7UUFDaEQsTUFBTSxtQkFBbUIsR0FBRyx3QkFBd0IsRUFBRSxDQUFDO1FBRXZELElBQUksbUJBQW1CLEVBQUU7WUFDdkIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDL0MsT0FBTztTQUNSO1FBRUQsOENBQThDO1FBQzlDLE1BQU0sa0JBQWtCLEdBQUcsd0JBQXdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFN0QsSUFDRSxrQkFBa0I7WUFDbEIsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxNQUFNO2dCQUMxQywwQkFBMEIsQ0FBQyxTQUFTLEVBQ3RDO1lBQ0EsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDOUM7YUFBTSxJQUFJLGVBQWUsS0FBSyxDQUFDLEVBQUU7WUFDaEMsZUFBZSxJQUFJLENBQUMsQ0FBQztTQUN0QjthQUFNO1lBQ0wsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDdkM7SUFDSCxDQUFDO0NBa2ZGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgVGVycmFXZWJFeHRlbnNpb25GZWF0dXJlcyxcbiAgV2ViRXh0ZW5zaW9uVHhTdGF0dXMsXG59IGZyb20gJ0B0ZXJyYS1kZXYvd2ViLWV4dGVuc2lvbi1pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQWNjQWRkcmVzcyxcbiAgQ3JlYXRlVHhPcHRpb25zLFxuICBQdWJsaWNLZXksXG4gIFR4LFxufSBmcm9tICdAdGVycmEtbW9uZXkvdGVycmEuanMnO1xuaW1wb3J0IHtcbiAgQ29ubmVjdGlvbixcbiAgQ29ubmVjdFR5cGUsXG4gIE5ldHdvcmtJbmZvLFxuICBTaWduQnl0ZXNSZXN1bHQsXG4gIFNpZ25SZXN1bHQsXG4gIFR4UmVzdWx0LFxuICBXYWxsZXRTdGF0ZXMsXG4gIFdhbGxldFN0YXR1cyxcbn0gZnJvbSAnQHRlcnJhLW1vbmV5L3VzZS13YWxsZXQnO1xuaW1wb3J0IGRlZXBFcXVhbCBmcm9tICdmYXN0LWRlZXAtZXF1YWwnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgQ0hST01FX0VYVEVOU0lPTl9JTlNUQUxMX1VSTCxcbiAgREVGQVVMVF9DSFJPTUVfRVhURU5TSU9OX0NPTVBBVElCTEVfQlJPV1NFUl9DSEVDSyxcbn0gZnJvbSAnLi9lbnYnO1xuaW1wb3J0IHtcbiAgbWFwRXh0ZW5zaW9uU2lnbkJ5dGVzRXJyb3IsXG4gIG1hcEV4dGVuc2lvblR4RXJyb3IsXG59IGZyb20gJy4vZXhjZXB0aW9uL21hcEV4dGVuc2lvblR4RXJyb3InO1xuaW1wb3J0IHsgbWFwV2FsbGV0Q29ubmVjdEVycm9yIH0gZnJvbSAnLi9leGNlcHRpb24vbWFwV2FsbGV0Q29ubmVjdEVycm9yJztcbmltcG9ydCB7XG4gIEV4dGVuc2lvblJvdXRlcixcbiAgRXh0ZW5zaW9uUm91dGVyU3RhdHVzLFxufSBmcm9tICcuL21vZHVsZXMvZXh0ZW5zaW9uLXJvdXRlcic7XG5pbXBvcnQge1xuICBFeHRlbnNpb25JbmZvLFxuICBnZXRUZXJyYUV4dGVuc2lvbnMsXG59IGZyb20gJy4vbW9kdWxlcy9leHRlbnNpb24tcm91dGVyL211bHRpQ2hhbm5lbCc7XG5pbXBvcnQge1xuICBjb25uZWN0IGFzIHJlQ29ubmVjdCxcbiAgY29ubmVjdElmU2Vzc2lvbkV4aXN0cyBhcyByZUNvbm5lY3RJZlNlc3Npb25FeGlzdHMsXG4gIFJlYWRvbmx5V2FsbGV0Q29udHJvbGxlcixcbiAgcmVhZG9ubHlXYWxsZXRNb2RhbCxcbiAgUmVhZG9ubHlXYWxsZXRTZXNzaW9uLFxufSBmcm9tICcuL21vZHVsZXMvcmVhZG9ubHktd2FsbGV0JztcbmltcG9ydCB7XG4gIGNvbm5lY3QgYXMgd2NDb25uZWN0LFxuICBjb25uZWN0SWZTZXNzaW9uRXhpc3RzIGFzIHdjQ29ubmVjdElmU2Vzc2lvbkV4aXN0cyxcbiAgV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIsXG4gIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyxcbiAgV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMsXG59IGZyb20gJy4vbW9kdWxlcy93YWxsZXRjb25uZWN0JztcbmltcG9ydCB7IGlzRGVza3RvcENocm9tZSB9IGZyb20gJy4vdXRpbHMvYnJvd3Nlci1jaGVjayc7XG5pbXBvcnQgeyBjaGVja0V4dGVuc2lvblJlYWR5IH0gZnJvbSAnLi91dGlscy9jaGVja0V4dGVuc2lvblJlYWR5JztcblxuZXhwb3J0IGludGVyZmFjZSBXYWxsZXRDb250cm9sbGVyT3B0aW9uc1xuICBleHRlbmRzIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiDimqDvuI8gRG9uJ3QgaGFyZGNvZGluZyB0aGlzLCB1c2UgZ2V0Q2hhaW4gT3B0aW9ucygpXG4gICAqXG4gICAqIGZhbGxiYWNrIG5ldHdvcmsgaWYgY29udHJvbGxlciBpcyBub3QgY29ubmVjdGVkXG4gICAqL1xuICBkZWZhdWx0TmV0d29yazogTmV0d29ya0luZm87XG5cbiAgLyoqXG4gICAqIOKaoO+4jyBEb24ndCBoYXJkY29kaW5nIHRoaXMsIHVzZSBnZXRDaGFpbiBPcHRpb25zKClcbiAgICpcbiAgICogZm9yIHdhbGxldGNvbm5lY3RcbiAgICpcbiAgICogVGhlIG5ldHdvcmsgcnVsZXMgcGFzc2VkIGJ5IHRoZSBUZXJyYSBTdGF0aW9uIE1vYmlsZSBhcmUgMCBpcyB0ZXN0bmV0LCAxIGlzIG1haW5uZXQuXG4gICAqXG4gICAqIEFsd2F5cyBzZXQgdGVzdG5ldCBmb3IgMCBhbmQgbWFpbm5ldCBmb3IgMS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgXG4gICAqIGNvbnN0IG1haW5uZXQ6IE5ldHdvcmtJbmZvID0ge1xuICAgKiAgbmFtZTogJ21haW5uZXQnLFxuICAgKiAgY2hhaW5JRDogJ2NvbHVtYnVzLTUnLFxuICAgKiAgbGNkOiAnaHR0cHM6Ly9sY2QudGVycmEuZGV2JyxcbiAgICogfVxuICAgKlxuICAgKiBjb25zdCB0ZXN0bmV0OiBOZXR3b3JrSW5mbyA9IHtcbiAgICogIG5hbWU6ICd0ZXN0bmV0JyxcbiAgICogIGNoYWluSUQ6ICdib21iYXktMTInLFxuICAgKiAgbGNkOiAnaHR0cHM6Ly9ib21iYXktbGNkLnRlcnJhLmRldicsXG4gICAqIH1cbiAgICpcbiAgICogY29uc3Qgd2FsbGV0Q29ubmVjdENoYWluSWRzOiBSZWNvcmQ8bnVtYmVyLCBOZXR3b3JrSW5mbz4gPSB7XG4gICAqICAgMDogdGVzdG5ldCxcbiAgICogICAxOiBtYWlubmV0LFxuICAgKiB9XG4gICAqXG4gICAqIDxXYWxsZXRQcm92aWRlciB3YWxsZXRDb25uZWN0Q2hhaW5JZHM9e3dhbGxldENvbm5lY3RDaGFpbklkc30+XG4gICAqIGBgYFxuICAgKi9cbiAgd2FsbGV0Q29ubmVjdENoYWluSWRzOiBSZWNvcmQ8bnVtYmVyLCBOZXR3b3JrSW5mbz47XG5cbiAgLyoqXG4gICAqIHJ1biBhdCBleGVjdXRpbmcgdGhlIGBjb25uZWN0KENvbm5lY3RUeXBlLlJFQURPTkxZKWBcbiAgICovXG4gIGNyZWF0ZVJlYWRvbmx5V2FsbGV0U2Vzc2lvbj86IChcbiAgICBuZXR3b3JrczogTmV0d29ya0luZm9bXSxcbiAgKSA9PiBQcm9taXNlPFJlYWRvbmx5V2FsbGV0U2Vzc2lvbiB8IG51bGw+O1xuXG4gIC8qKlxuICAgKiBydW4gYXQgZXhlY3V0aW5nIHRoZSBgY29ubmVjdChDb25uZWN0VHlwZS5FWFRFTlNJT04pYFxuICAgKiBpZiB1c2VyIGluc3RhbGxlZCBtdWx0aXBsZSB3YWxsZXRzXG4gICAqL1xuICBzZWxlY3RFeHRlbnNpb24/OiAoXG4gICAgZXh0ZW5zaW9uSW5mb3M6IEV4dGVuc2lvbkluZm9bXSxcbiAgKSA9PiBQcm9taXNlPEV4dGVuc2lvbkluZm8gfCBudWxsPjtcblxuICAvKipcbiAgICogbWlsbGlzZWNvbmRzIHRvIHdhaXQgY2hlY2tpbmcgY2hyb21lIGV4dGVuc2lvbiBpcyBpbnN0YWxsZWRcbiAgICpcbiAgICogQGRlZmF1bHQgMTAwMCAqIDMgbWlsaXNlY29uZHNcbiAgICovXG4gIHdhaXRpbmdDaHJvbWVFeHRlbnNpb25JbnN0YWxsQ2hlY2s/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIOKaoO+4jyBUaGlzIEFQSSBpcyBhbiBvcHRpb24gZm9yIHdhbGxldCBkZXZlbG9wZXJzLiBQbGVhc2UgZG9uJ3QgdXNlIGRBcHAgZGV2ZWxvcGVycy5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgXG4gICAqIDxXYWxsZXRQcm92aWRlciBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjaz17KHVzZXJBZ2VudDogc3RyaW5nKSA9PiB7XG4gICAqICAgcmV0dXJuIC9NeVdhbGxldFxcLy8udGVzdCh1c2VyQWdlbnQpO1xuICAgKiB9fT5cbiAgICogYGBgXG4gICAqL1xuICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjaz86IChcbiAgICB1c2VyQWdlbnQ6IHN0cmluZyxcbiAgKSA9PiBib29sZWFuO1xufVxuXG5jb25zdCBDT05ORUNUSU9OUyA9IHtcbiAgW0Nvbm5lY3RUeXBlLlJFQURPTkxZXToge1xuICAgIHR5cGU6IENvbm5lY3RUeXBlLlJFQURPTkxZLFxuICAgIG5hbWU6ICdWaWV3IGFuIGFkZHJlc3MnLFxuICAgIGljb246ICdodHRwczovL2Fzc2V0cy50ZXJyYS5tb25leS9pY29uL3N0YXRpb24tZXh0ZW5zaW9uL2ljb24ucG5nJyxcbiAgfSBhcyBDb25uZWN0aW9uLFxuICBbQ29ubmVjdFR5cGUuV0FMTEVUQ09OTkVDVF06IHtcbiAgICB0eXBlOiBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNULFxuICAgIG5hbWU6ICdUZXJyYSBTdGF0aW9uIE1vYmlsZScsXG4gICAgaWNvbjogJ2h0dHBzOi8vYXNzZXRzLnRlcnJhLm1vbmV5L2ljb24vc3RhdGlvbi1leHRlbnNpb24vaWNvbi5wbmcnLFxuICB9IGFzIENvbm5lY3Rpb24sXG59IGFzIGNvbnN0O1xuXG5jb25zdCBERUZBVUxUX1dBSVRJTkdfQ0hST01FX0VYVEVOU0lPTl9JTlNUQUxMX0NIRUNLID0gMTAwMCAqIDM7XG5jb25zdCBXQUxMRVRDT05ORUNUX1NVUFBPUlRfRkVBVFVSRVMgPSBuZXcgU2V0PFRlcnJhV2ViRXh0ZW5zaW9uRmVhdHVyZXM+KFtcbiAgJ3Bvc3QnLFxuXSk7XG5jb25zdCBFTVBUWV9TVVBQT1JUX0ZFQVRVUkVTID0gbmV3IFNldDxUZXJyYVdlYkV4dGVuc2lvbkZlYXR1cmVzPigpO1xuXG5leHBvcnQgY2xhc3MgV2FsbGV0Q29udHJvbGxlciB7XG4gIHByaXZhdGUgZXh0ZW5zaW9uOiBFeHRlbnNpb25Sb3V0ZXIgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSB3YWxsZXRDb25uZWN0OiBXYWxsZXRDb25uZWN0Q29udHJvbGxlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHJlYWRvbmx5V2FsbGV0OiBSZWFkb25seVdhbGxldENvbnRyb2xsZXIgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIF9hdmFpbGFibGVDb25uZWN0VHlwZXM6IEJlaGF2aW9yU3ViamVjdDxDb25uZWN0VHlwZVtdPjtcbiAgcHJpdmF0ZSBfYXZhaWxhYmxlSW5zdGFsbFR5cGVzOiBCZWhhdmlvclN1YmplY3Q8Q29ubmVjdFR5cGVbXT47XG4gIHByaXZhdGUgX3N0YXRlczogQmVoYXZpb3JTdWJqZWN0PFdhbGxldFN0YXRlcz47XG5cbiAgcHJpdmF0ZSBkaXNhYmxlUmVhZG9ubHlXYWxsZXQ6ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRpc2FibGVFeHRlbnNpb246ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGRpc2FibGVXYWxsZXRDb25uZWN0OiAoKCkgPT4gdm9pZCkgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIHJlYWRvbmx5IF9ub3RDb25uZWN0ZWQ6IFdhbGxldFN0YXRlcztcbiAgcHJpdmF0ZSByZWFkb25seSBfaW5pdGlhbGl6aW5nOiBXYWxsZXRTdGF0ZXM7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgb3B0aW9uczogV2FsbGV0Q29udHJvbGxlck9wdGlvbnMpIHtcbiAgICB0aGlzLl9ub3RDb25uZWN0ZWQgPSB7XG4gICAgICBzdGF0dXM6IFdhbGxldFN0YXR1cy5XQUxMRVRfTk9UX0NPTk5FQ1RFRCxcbiAgICAgIG5ldHdvcms6IG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgfTtcblxuICAgIHRoaXMuX2luaXRpYWxpemluZyA9IHtcbiAgICAgIHN0YXR1czogV2FsbGV0U3RhdHVzLklOSVRJQUxJWklORyxcbiAgICAgIG5ldHdvcms6IG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgfTtcblxuICAgIHRoaXMuX2F2YWlsYWJsZUNvbm5lY3RUeXBlcyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29ubmVjdFR5cGVbXT4oW1xuICAgICAgQ29ubmVjdFR5cGUuUkVBRE9OTFksXG4gICAgICBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNULFxuICAgIF0pO1xuXG4gICAgdGhpcy5fYXZhaWxhYmxlSW5zdGFsbFR5cGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb25uZWN0VHlwZVtdPihbXSk7XG5cbiAgICB0aGlzLl9zdGF0ZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFdhbGxldFN0YXRlcz4odGhpcy5faW5pdGlhbGl6aW5nKTtcblxuICAgIGxldCBudW1TZXNzaW9uQ2hlY2s6IG51bWJlciA9IDA7XG5cbiAgICAvLyB3YWl0IGNoZWNraW5nIHRoZSBhdmFpbGFiaWxpdHkgb2YgdGhlIGNocm9tZSBleHRlbnNpb25cbiAgICAvLyAwLiBjaGVjayBpZiBleHRlbnNpb24gd2FsbGV0IHNlc3Npb24gaXMgZXhpc3RzXG4gICAgY2hlY2tFeHRlbnNpb25SZWFkeShcbiAgICAgIG9wdGlvbnMud2FpdGluZ0Nocm9tZUV4dGVuc2lvbkluc3RhbGxDaGVjayA/P1xuICAgICAgICBERUZBVUxUX1dBSVRJTkdfQ0hST01FX0VYVEVOU0lPTl9JTlNUQUxMX0NIRUNLLFxuICAgICAgdGhpcy5pc0Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyKCksXG4gICAgKS50aGVuKChyZWFkeTogYm9vbGVhbikgPT4ge1xuICAgICAgaWYgKHJlYWR5KSB7XG4gICAgICAgIHRoaXMuX2F2YWlsYWJsZUNvbm5lY3RUeXBlcy5uZXh0KFtcbiAgICAgICAgICBDb25uZWN0VHlwZS5FWFRFTlNJT04sXG4gICAgICAgICAgQ29ubmVjdFR5cGUuV0FMTEVUQ09OTkVDVCxcbiAgICAgICAgICBDb25uZWN0VHlwZS5SRUFET05MWSxcbiAgICAgICAgXSk7XG5cbiAgICAgICAgdGhpcy5leHRlbnNpb24gPSBuZXcgRXh0ZW5zaW9uUm91dGVyKHtcbiAgICAgICAgICBob3N0V2luZG93OiB3aW5kb3csXG4gICAgICAgICAgc2VsZWN0RXh0ZW5zaW9uOiBvcHRpb25zLnNlbGVjdEV4dGVuc2lvbixcbiAgICAgICAgICBkYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjazpcbiAgICAgICAgICAgIG9wdGlvbnMuZGFuZ2Vyb3VzbHlfX2Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyQ2hlY2sgPz9cbiAgICAgICAgICAgIERFRkFVTFRfQ0hST01FX0VYVEVOU0lPTl9DT01QQVRJQkxFX0JST1dTRVJfQ0hFQ0ssXG4gICAgICAgICAgZGVmYXVsdE5ldHdvcms6IG9wdGlvbnMuZGVmYXVsdE5ldHdvcmssXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuZXh0ZW5zaW9uXG4gICAgICAgICAgLnN0YXRlcygpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKHsgdHlwZSB9KSA9PiB0eXBlICE9PSBFeHRlbnNpb25Sb3V0ZXJTdGF0dXMuSU5JVElBTElaSU5HKSxcbiAgICAgICAgICApXG4gICAgICAgICAgLnN1YnNjcmliZSgoZXh0ZW5zaW9uU3RhdGVzKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIH0gY2F0Y2gge31cblxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBleHRlbnNpb25TdGF0ZXMudHlwZSA9PT0gRXh0ZW5zaW9uUm91dGVyU3RhdHVzLldBTExFVF9DT05ORUNURUQgJiZcbiAgICAgICAgICAgICAgIXRoaXMuZGlzYWJsZVdhbGxldENvbm5lY3QgJiZcbiAgICAgICAgICAgICAgIXRoaXMuZGlzYWJsZVJlYWRvbmx5V2FsbGV0XG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgdGhpcy5lbmFibGVFeHRlbnNpb24oKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobnVtU2Vzc2lvbkNoZWNrID09PSAwKSB7XG4gICAgICAgICAgICAgIG51bVNlc3Npb25DaGVjayArPSAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZXModGhpcy5fbm90Q29ubmVjdGVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChpc0Rlc2t0b3BDaHJvbWUodGhpcy5pc0Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyKCkpKSB7XG4gICAgICAgICAgdGhpcy5fYXZhaWxhYmxlSW5zdGFsbFR5cGVzLm5leHQoW0Nvbm5lY3RUeXBlLkVYVEVOU0lPTl0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG51bVNlc3Npb25DaGVjayA9PT0gMCkge1xuICAgICAgICAgIG51bVNlc3Npb25DaGVjayArPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIDEuIGNoZWNrIGlmIHJlYWRvbmx5IHdhbGxldCBzZXNzaW9uIGlzIGV4aXN0c1xuICAgIGNvbnN0IGRyYWZ0UmVhZG9ubHlXYWxsZXQgPSByZUNvbm5lY3RJZlNlc3Npb25FeGlzdHMoKTtcblxuICAgIGlmIChkcmFmdFJlYWRvbmx5V2FsbGV0KSB7XG4gICAgICB0aGlzLmVuYWJsZVJlYWRvbmx5V2FsbGV0KGRyYWZ0UmVhZG9ubHlXYWxsZXQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIDIuIGNoZWNrIGlmIHdhbGxldGNvbm5lY3Qgc2VzaXNvbiBpcyBleGlzdHNcbiAgICBjb25zdCBkcmFmdFdhbGxldENvbm5lY3QgPSB3Y0Nvbm5lY3RJZlNlc3Npb25FeGlzdHMob3B0aW9ucyk7XG5cbiAgICBpZiAoXG4gICAgICBkcmFmdFdhbGxldENvbm5lY3QgJiZcbiAgICAgIGRyYWZ0V2FsbGV0Q29ubmVjdC5nZXRMYXRlc3RTZXNzaW9uKCkuc3RhdHVzID09PVxuICAgICAgICBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5DT05ORUNURURcbiAgICApIHtcbiAgICAgIHRoaXMuZW5hYmxlV2FsbGV0Q29ubmVjdChkcmFmdFdhbGxldENvbm5lY3QpO1xuICAgIH0gZWxzZSBpZiAobnVtU2Vzc2lvbkNoZWNrID09PSAwKSB7XG4gICAgICBudW1TZXNzaW9uQ2hlY2sgKz0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZXModGhpcy5fbm90Q29ubmVjdGVkKTtcbiAgICB9XG4gIH1cblxuICAvKiogQHNlZSBXYWxsZXQjaXNDaHJvbWVFeHRlbnNpb25Db21wYXRpYmxlQnJvd3NlciAqL1xuICBpc0Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyID0gKCk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLm9wdGlvbnMuZGFuZ2Vyb3VzbHlfX2Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyQ2hlY2sgPz9cbiAgICAgIERFRkFVTFRfQ0hST01FX0VYVEVOU0lPTl9DT01QQVRJQkxFX0JST1dTRVJfQ0hFQ0tcbiAgICApKG5hdmlnYXRvci51c2VyQWdlbnQpO1xuICB9O1xuXG4gIC8qKiBAc2VlIFdhbGxldCNhdmFpbGFibGVDb25uZWN0VHlwZXMgKi9cbiAgYXZhaWxhYmxlQ29ubmVjdFR5cGVzID0gKCk6IE9ic2VydmFibGU8Q29ubmVjdFR5cGVbXT4gPT4ge1xuICAgIHJldHVybiB0aGlzLl9hdmFpbGFibGVDb25uZWN0VHlwZXMuYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I2F2YWlsYWJsZUNvbm5lY3Rpb25zICovXG4gIGF2YWlsYWJsZUNvbm5lY3Rpb25zID0gKCk6IE9ic2VydmFibGU8Q29ubmVjdGlvbltdPiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuX2F2YWlsYWJsZUNvbm5lY3RUeXBlcy5waXBlKFxuICAgICAgbWFwKChjb25uZWN0VHlwZXMpID0+IHtcbiAgICAgICAgY29uc3QgY29ubmVjdGlvbnM6IENvbm5lY3Rpb25bXSA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgY29ubmVjdFR5cGUgb2YgY29ubmVjdFR5cGVzKSB7XG4gICAgICAgICAgaWYgKGNvbm5lY3RUeXBlID09PSBDb25uZWN0VHlwZS5FWFRFTlNJT04pIHtcbiAgICAgICAgICAgIGNvbnN0IHRlcnJhRXh0ZW5zaW9ucyA9IGdldFRlcnJhRXh0ZW5zaW9ucygpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlcnJhRXh0ZW5zaW9uIG9mIHRlcnJhRXh0ZW5zaW9ucykge1xuICAgICAgICAgICAgICBjb25uZWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICB0eXBlOiBDb25uZWN0VHlwZS5FWFRFTlNJT04sXG4gICAgICAgICAgICAgICAgaWRlbnRpZmllcjogdGVycmFFeHRlbnNpb24uaWRlbnRpZmllcixcbiAgICAgICAgICAgICAgICBuYW1lOiB0ZXJyYUV4dGVuc2lvbi5uYW1lLFxuICAgICAgICAgICAgICAgIGljb246IHRlcnJhRXh0ZW5zaW9uLmljb24sXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25uZWN0aW9ucy5wdXNoKENPTk5FQ1RJT05TW2Nvbm5lY3RUeXBlXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb25zO1xuICAgICAgfSksXG4gICAgKTtcbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjYXZhaWxhYmxlSW5zdGFsbFR5cGVzICovXG4gIGF2YWlsYWJsZUluc3RhbGxUeXBlcyA9ICgpOiBPYnNlcnZhYmxlPENvbm5lY3RUeXBlW10+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlSW5zdGFsbFR5cGVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAc2VlIFdhbGxldCNzdGF0dXNcbiAgICogQHNlZSBXYWxsZXQjbmV0d29ya1xuICAgKiBAc2VlIFdhbGxldCN3YWxsZXRzXG4gICAqL1xuICBzdGF0ZXMgPSAoKTogT2JzZXJ2YWJsZTxXYWxsZXRTdGF0ZXM+ID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdGVzLmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIC8qKiBAc2VlIFdhbGxldCNyZWNoZWNrU3RhdHVzICovXG4gIHJlZmV0Y2hTdGF0ZXMgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZUV4dGVuc2lvbikge1xuICAgICAgdGhpcy5leHRlbnNpb24/LnJlZmV0Y2hTdGF0ZXMoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqIEBzZWUgV2FsbGV0I2luc3RhbGwgKi9cbiAgaW5zdGFsbCA9ICh0eXBlOiBDb25uZWN0VHlwZSkgPT4ge1xuICAgIGlmICh0eXBlID09PSBDb25uZWN0VHlwZS5FWFRFTlNJT04pIHtcbiAgICAgIC8vIFRPRE8gc2VwYXJhdGUgaW5zdGFsbCBsaW5rcyBieSBicm93c2VyIHR5cGVzXG4gICAgICB3aW5kb3cub3BlbihDSFJPTUVfRVhURU5TSU9OX0lOU1RBTExfVVJMLCAnX2JsYW5rJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYFtXYWxsZXRDb250cm9sbGVyXSBDb25uZWN0VHlwZSBcIiR7dHlwZX1cIiBkb2VzIG5vdCBzdXBwb3J0IGluc3RhbGwoKSBmdW5jdGlvbmAsXG4gICAgICApO1xuICAgIH1cbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjY29ubmVjdCAqL1xuICBjb25uZWN0ID0gKHR5cGU6IENvbm5lY3RUeXBlLCBpZGVudGlmaWVyPzogc3RyaW5nKSA9PiB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIENvbm5lY3RUeXBlLlJFQURPTkxZOlxuICAgICAgICBjb25zdCBuZXR3b3JrczogTmV0d29ya0luZm9bXSA9IE9iamVjdC5rZXlzKFxuICAgICAgICAgIHRoaXMub3B0aW9ucy53YWxsZXRDb25uZWN0Q2hhaW5JZHMsXG4gICAgICAgICkubWFwKChjaGFpbklkKSA9PiB0aGlzLm9wdGlvbnMud2FsbGV0Q29ubmVjdENoYWluSWRzWytjaGFpbklkXSk7XG5cbiAgICAgICAgY29uc3QgY3JlYXRlUmVhZG9ubHlXYWxsZXRTZXNzaW9uID1cbiAgICAgICAgICB0aGlzLm9wdGlvbnMuY3JlYXRlUmVhZG9ubHlXYWxsZXRTZXNzaW9uPy4obmV0d29ya3MpID8/XG4gICAgICAgICAgcmVhZG9ubHlXYWxsZXRNb2RhbCh7IG5ldHdvcmtzIH0pO1xuXG4gICAgICAgIGNyZWF0ZVJlYWRvbmx5V2FsbGV0U2Vzc2lvbi50aGVuKChyZWFkb25seVdhbGxldFNlc3Npb24pID0+IHtcbiAgICAgICAgICBpZiAocmVhZG9ubHlXYWxsZXRTZXNzaW9uKSB7XG4gICAgICAgICAgICB0aGlzLmVuYWJsZVJlYWRvbmx5V2FsbGV0KHJlQ29ubmVjdChyZWFkb25seVdhbGxldFNlc3Npb24pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQ29ubmVjdFR5cGUuV0FMTEVUQ09OTkVDVDpcbiAgICAgICAgdGhpcy5lbmFibGVXYWxsZXRDb25uZWN0KHdjQ29ubmVjdCh0aGlzLm9wdGlvbnMpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIENvbm5lY3RUeXBlLkVYVEVOU0lPTjpcbiAgICAgICAgaWYgKCF0aGlzLmV4dGVuc2lvbikge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZXh0ZW5zaW9uIGluc3RhbmNlIGlzIG5vdCBjcmVhdGVkIWApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZXh0ZW5zaW9uLmNvbm5lY3QoaWRlbnRpZmllcik7XG4gICAgICAgIHRoaXMuZW5hYmxlRXh0ZW5zaW9uKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIENvbm5lY3RUeXBlIWApO1xuICAgIH1cbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjY29ubmVjdFJlYWRvbmx5ICovXG4gIGNvbm5lY3RSZWFkb25seSA9ICh0ZXJyYUFkZHJlc3M6IHN0cmluZywgbmV0d29yazogTmV0d29ya0luZm8pID0+IHtcbiAgICB0aGlzLmVuYWJsZVJlYWRvbmx5V2FsbGV0KFxuICAgICAgcmVDb25uZWN0KHtcbiAgICAgICAgdGVycmFBZGRyZXNzLFxuICAgICAgICBuZXR3b3JrLFxuICAgICAgfSksXG4gICAgKTtcbiAgfTtcblxuICAvKiogQHNlZSBXYWxsZXQjZGlzY29ubmVjdCAqL1xuICBkaXNjb25uZWN0ID0gKCkgPT4ge1xuICAgIHRoaXMuZGlzYWJsZVJlYWRvbmx5V2FsbGV0Py4oKTtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldCA9IG51bGw7XG5cbiAgICB0aGlzLmRpc2FibGVFeHRlbnNpb24/LigpO1xuICAgIHRoaXMuZGlzYWJsZUV4dGVuc2lvbiA9IG51bGw7XG5cbiAgICB0aGlzLmRpc2FibGVXYWxsZXRDb25uZWN0Py4oKTtcbiAgICB0aGlzLmRpc2FibGVXYWxsZXRDb25uZWN0ID0gbnVsbDtcblxuICAgIHRoaXMudXBkYXRlU3RhdGVzKHRoaXMuX25vdENvbm5lY3RlZCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBzZWUgV2FsbGV0I3Bvc3RcbiAgICogQHBhcmFtIHR4XG4gICAqIEBwYXJhbSB0ZXJyYUFkZHJlc3Mgb25seSBhdmFpbGFibGUgbmV3IGV4dGVuc2lvblxuICAgKi9cbiAgcG9zdCA9IGFzeW5jIChcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICAgIHRlcnJhQWRkcmVzcz86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxUeFJlc3VsdD4gPT4ge1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIGV4dGVuc2lvblxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGlmICh0aGlzLmRpc2FibGVFeHRlbnNpb24pIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxUeFJlc3VsdD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuZXh0ZW5zaW9uKSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgZXh0ZW5zaW9uIGluc3RhbmNlIG5vdCBjcmVhdGVkIWApKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmV4dGVuc2lvbi5wb3N0KHR4LCB0ZXJyYUFkZHJlc3MpLnN1YnNjcmliZSh7XG4gICAgICAgICAgbmV4dDogKHR4UmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBpZiAodHhSZXN1bHQuc3RhdHVzID09PSBXZWJFeHRlbnNpb25UeFN0YXR1cy5TVUNDRUVEKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgIC4uLnR4LFxuICAgICAgICAgICAgICAgIHJlc3VsdDogdHhSZXN1bHQucGF5bG9hZCxcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICByZWplY3QobWFwRXh0ZW5zaW9uVHhFcnJvcih0eCwgZXJyb3IpKTtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIHdhbGxldCBjb25uZWN0XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgZWxzZSBpZiAodGhpcy53YWxsZXRDb25uZWN0KSB7XG4gICAgICByZXR1cm4gdGhpcy53YWxsZXRDb25uZWN0XG4gICAgICAgIC5wb3N0KHR4KVxuICAgICAgICAudGhlbihcbiAgICAgICAgICAocmVzdWx0KSA9PlxuICAgICAgICAgICAgKHtcbiAgICAgICAgICAgICAgLi4udHgsXG4gICAgICAgICAgICAgIHJlc3VsdCxcbiAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIH0gYXMgVHhSZXN1bHQpLFxuICAgICAgICApXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICB0aHJvdyBtYXBXYWxsZXRDb25uZWN0RXJyb3IodHgsIGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlcmUgYXJlIG5vIGNvbm5lY3Rpb25zIHRoYXQgY2FuIGJlIHBvc3RpbmcgdHghYCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBAc2VlIFdhbGxldCNzaWduXG4gICAqIEBwYXJhbSB0eFxuICAgKiBAcGFyYW0gdGVycmFBZGRyZXNzIG9ubHkgYXZhaWxhYmxlIG5ldyBleHRlbnNpb25cbiAgICovXG4gIHNpZ24gPSBhc3luYyAoXG4gICAgdHg6IENyZWF0ZVR4T3B0aW9ucyxcbiAgICB0ZXJyYUFkZHJlc3M/OiBzdHJpbmcsXG4gICk6IFByb21pc2U8U2lnblJlc3VsdD4gPT4ge1xuICAgIGlmICh0aGlzLmRpc2FibGVFeHRlbnNpb24pIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxTaWduUmVzdWx0PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5leHRlbnNpb24pIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBleHRlbnNpb24gaW5zdGFuY2UgaXMgbm90IGNyZWF0ZWQhYCkpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuZXh0ZW5zaW9uLnNpZ24odHgsIHRlcnJhQWRkcmVzcykuc3Vic2NyaWJlKHtcbiAgICAgICAgICBuZXh0OiAodHhSZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmICh0eFJlc3VsdC5zdGF0dXMgPT09IFdlYkV4dGVuc2lvblR4U3RhdHVzLlNVQ0NFRUQpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgLi4udHgsXG4gICAgICAgICAgICAgICAgcmVzdWx0OiBUeC5mcm9tRGF0YSh0eFJlc3VsdC5wYXlsb2FkKSxcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICByZWplY3QobWFwRXh0ZW5zaW9uVHhFcnJvcih0eCwgZXJyb3IpKTtcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBzaWduKCkgbWV0aG9kIG9ubHkgYXZhaWxhYmxlIG9uIGV4dGVuc2lvbmApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAc2VlIFdhbGxldCNzaWduQnl0ZXNcbiAgICogQHBhcmFtIGJ5dGVzXG4gICAqIEBwYXJhbSB0ZXJyYUFkZHJlc3Mgb25seSBhdmFpbGFibGUgbmV3IGV4dGVuc2lvblxuICAgKi9cbiAgc2lnbkJ5dGVzID0gYXN5bmMgKFxuICAgIGJ5dGVzOiBCdWZmZXIsXG4gICAgdGVycmFBZGRyZXNzPzogc3RyaW5nLFxuICApOiBQcm9taXNlPFNpZ25CeXRlc1Jlc3VsdD4gPT4ge1xuICAgIGlmICh0aGlzLmRpc2FibGVFeHRlbnNpb24pIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxTaWduQnl0ZXNSZXN1bHQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmV4dGVuc2lvbikge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYGV4dGVuc2lvbiBpbnN0YW5jZSBpcyBub3QgY3JlYXRlZCFgKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5leHRlbnNpb25cbiAgICAgICAgICAuc2lnbkJ5dGVzKGJ5dGVzLCB0ZXJyYUFkZHJlc3MpXG4gICAgICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgICAgICBuZXh0OiAodHhSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHR4UmVzdWx0LnN0YXR1cyA9PT0gV2ViRXh0ZW5zaW9uVHhTdGF0dXMuU1VDQ0VFRCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgcmVzdWx0OiB7XG4gICAgICAgICAgICAgICAgICAgIHJlY2lkOiB0eFJlc3VsdC5wYXlsb2FkLnJlY2lkLFxuICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmU6IFVpbnQ4QXJyYXkuZnJvbShcbiAgICAgICAgICAgICAgICAgICAgICBCdWZmZXIuZnJvbSh0eFJlc3VsdC5wYXlsb2FkLnNpZ25hdHVyZSwgJ2Jhc2U2NCcpLFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBwdWJsaWNfa2V5OiB0eFJlc3VsdC5wYXlsb2FkLnB1YmxpY19rZXlcbiAgICAgICAgICAgICAgICAgICAgICA/IFB1YmxpY0tleS5mcm9tRGF0YSh0eFJlc3VsdC5wYXlsb2FkLnB1YmxpY19rZXkpXG4gICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yOiAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KG1hcEV4dGVuc2lvblNpZ25CeXRlc0Vycm9yKGJ5dGVzLCBlcnJvcikpO1xuICAgICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHNpZ25CeXRlcygpIG1ldGhvZCBvbmx5IGF2YWlsYWJsZSBvbiBleHRlbnNpb25gKTtcbiAgICAvLyBUT0RPIGltcGxlbWVudHMgc2lnbkJ5dGVzKCkgdG8gb3RoZXIgY29ubmVjdCB0eXBlc1xuICB9O1xuXG4gIC8qKlxuICAgKiBAc2VlIFdhbGxldCNoYXNDVzIwVG9rZW5zXG4gICAqIEBwYXJhbSBjaGFpbklEXG4gICAqIEBwYXJhbSB0b2tlbkFkZHJzIFRva2VuIGFkZHJlc3Nlc1xuICAgKi9cbiAgaGFzQ1cyMFRva2VucyA9IGFzeW5jIChcbiAgICBjaGFpbklEOiBzdHJpbmcsXG4gICAgLi4udG9rZW5BZGRyczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTx7IFt0b2tlbkFkZHI6IHN0cmluZ106IGJvb2xlYW4gfT4gPT4ge1xuICAgIGlmICh0aGlzLmF2YWlsYWJsZUV4dGVuc2lvbkZlYXR1cmUoJ2N3MjAtdG9rZW4nKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZXh0ZW5zaW9uIS5oYXNDVzIwVG9rZW5zKGNoYWluSUQsIC4uLnRva2VuQWRkcnMpO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihgRG9lcyBub3Qgc3VwcG9ydCBoYXNDVzIwVG9rZW5zKCkgb24gdGhpcyBjb25uZWN0aW9uYCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBzZWUgV2FsbGV0I2FkZENXMjBUb2tlbnNcbiAgICogQHBhcmFtIGNoYWluSURcbiAgICogQHBhcmFtIHRva2VuQWRkcnMgVG9rZW4gYWRkcmVzc2VzXG4gICAqL1xuICBhZGRDVzIwVG9rZW5zID0gYXN5bmMgKFxuICAgIGNoYWluSUQ6IHN0cmluZyxcbiAgICAuLi50b2tlbkFkZHJzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPHsgW3Rva2VuQWRkcjogc3RyaW5nXTogYm9vbGVhbiB9PiA9PiB7XG4gICAgaWYgKHRoaXMuYXZhaWxhYmxlRXh0ZW5zaW9uRmVhdHVyZSgnY3cyMC10b2tlbicpKSB7XG4gICAgICByZXR1cm4gdGhpcy5leHRlbnNpb24hLmFkZENXMjBUb2tlbnMoY2hhaW5JRCwgLi4udG9rZW5BZGRycyk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBEb2VzIG5vdCBzdXBwb3J0IGFkZENXMjBUb2tlbnMoKSBvbiB0aGlzIGNvbm5lY3Rpb25gKTtcbiAgfTtcblxuICAvKipcbiAgICogQHNlZSBXYWxsZXQjaGFzTmV0d29ya1xuICAgKiBAcGFyYW0gbmV0d29ya1xuICAgKi9cbiAgaGFzTmV0d29yayA9IChuZXR3b3JrOiBPbWl0PE5ldHdvcmtJbmZvLCAnbmFtZSc+KTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgaWYgKHRoaXMuYXZhaWxhYmxlRXh0ZW5zaW9uRmVhdHVyZSgnbmV0d29yaycpKSB7XG4gICAgICByZXR1cm4gdGhpcy5leHRlbnNpb24hLmhhc05ldHdvcmsobmV0d29yayk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBEb2VzIG5vdCBzdXBwb3J0IGhhc05ldHdvcmsoKSBvbiB0aGlzIGNvbm5lY3Rpb25gKTtcbiAgfTtcblxuICAvKipcbiAgICogQHNlZSBXYWxsZXQjaGFzTmV0d29ya1xuICAgKiBAcGFyYW0gbmV0d29ya1xuICAgKi9cbiAgYWRkTmV0d29yayA9IChuZXR3b3JrOiBOZXR3b3JrSW5mbyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGlmICh0aGlzLmF2YWlsYWJsZUV4dGVuc2lvbkZlYXR1cmUoJ25ldHdvcmsnKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZXh0ZW5zaW9uIS5hZGROZXR3b3JrKG5ldHdvcmspO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBFcnJvcihgRG9lcyBub3Qgc3VwcG9ydCBhZGROZXR3b3JrKCkgb24gdGhpcyBjb25uZWN0aW9uYCk7XG4gIH07XG5cbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAvLyBpbnRlcm5hbFxuICAvLyBjb25uZWN0IHR5cGUgY2hhbmdpbmdcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICBwcml2YXRlIGF2YWlsYWJsZUV4dGVuc2lvbkZlYXR1cmUgPSAoZmVhdHVyZTogVGVycmFXZWJFeHRlbnNpb25GZWF0dXJlcykgPT4ge1xuICAgIGlmICh0aGlzLmRpc2FibGVFeHRlbnNpb24gJiYgdGhpcy5leHRlbnNpb24pIHtcbiAgICAgIGNvbnN0IHN0YXRlcyA9IHRoaXMuZXh0ZW5zaW9uLmdldExhc3RTdGF0ZXMoKTtcblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgc3RhdGVzLnR5cGUgPT09IEV4dGVuc2lvblJvdXRlclN0YXR1cy5XQUxMRVRfQ09OTkVDVEVEICYmXG4gICAgICAgIHN0YXRlcy5zdXBwb3J0RmVhdHVyZXMuaGFzKGZlYXR1cmUpXG4gICAgICApO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIHVwZGF0ZVN0YXRlcyA9IChuZXh0OiBXYWxsZXRTdGF0ZXMpID0+IHtcbiAgICBjb25zdCBwcmV2ID0gdGhpcy5fc3RhdGVzLmdldFZhbHVlKCk7XG5cbiAgICBpZiAoXG4gICAgICBuZXh0LnN0YXR1cyA9PT0gV2FsbGV0U3RhdHVzLldBTExFVF9DT05ORUNURUQgJiZcbiAgICAgIG5leHQud2FsbGV0cy5sZW5ndGggPT09IDBcbiAgICApIHtcbiAgICAgIG5leHQgPSB7XG4gICAgICAgIHN0YXR1czogV2FsbGV0U3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVELFxuICAgICAgICBuZXR3b3JrOiBuZXh0Lm5ldHdvcmssXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChwcmV2LnN0YXR1cyAhPT0gbmV4dC5zdGF0dXMgfHwgIWRlZXBFcXVhbChwcmV2LCBuZXh0KSkge1xuICAgICAgdGhpcy5fc3RhdGVzLm5leHQobmV4dCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgZW5hYmxlUmVhZG9ubHlXYWxsZXQgPSAocmVhZG9ubHlXYWxsZXQ6IFJlYWRvbmx5V2FsbGV0Q29udHJvbGxlcikgPT4ge1xuICAgIHRoaXMuZGlzYWJsZVdhbGxldENvbm5lY3Q/LigpO1xuICAgIHRoaXMuZGlzYWJsZUV4dGVuc2lvbj8uKCk7XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLnJlYWRvbmx5V2FsbGV0ID09PSByZWFkb25seVdhbGxldCB8fFxuICAgICAgKHRoaXMucmVhZG9ubHlXYWxsZXQ/LnRlcnJhQWRkcmVzcyA9PT0gcmVhZG9ubHlXYWxsZXQudGVycmFBZGRyZXNzICYmXG4gICAgICAgIHRoaXMucmVhZG9ubHlXYWxsZXQubmV0d29yayA9PT0gcmVhZG9ubHlXYWxsZXQubmV0d29yaylcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFkb25seVdhbGxldCkge1xuICAgICAgdGhpcy5yZWFkb25seVdhbGxldC5kaXNjb25uZWN0KCk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWFkb25seVdhbGxldCA9IHJlYWRvbmx5V2FsbGV0O1xuXG4gICAgdGhpcy51cGRhdGVTdGF0ZXMoe1xuICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgIG5ldHdvcms6IHJlYWRvbmx5V2FsbGV0Lm5ldHdvcmssXG4gICAgICB3YWxsZXRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBjb25uZWN0VHlwZTogQ29ubmVjdFR5cGUuUkVBRE9OTFksXG4gICAgICAgICAgdGVycmFBZGRyZXNzOiByZWFkb25seVdhbGxldC50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgZGVzaWduOiAncmVhZG9ubHknLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIHN1cHBvcnRGZWF0dXJlczogRU1QVFlfU1VQUE9SVF9GRUFUVVJFUyxcbiAgICB9KTtcblxuICAgIHRoaXMuZGlzYWJsZVJlYWRvbmx5V2FsbGV0ID0gKCkgPT4ge1xuICAgICAgcmVhZG9ubHlXYWxsZXQuZGlzY29ubmVjdCgpO1xuICAgICAgdGhpcy5yZWFkb25seVdhbGxldCA9IG51bGw7XG4gICAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldCA9IG51bGw7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIGVuYWJsZUV4dGVuc2lvbiA9ICgpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdD8uKCk7XG5cbiAgICBpZiAodGhpcy5kaXNhYmxlRXh0ZW5zaW9uIHx8ICF0aGlzLmV4dGVuc2lvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dGVuc2lvblN1YnNjcmlwdGlvbiA9IHRoaXMuZXh0ZW5zaW9uLnN0YXRlcygpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAoZXh0ZW5zaW9uU3RhdGVzKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBleHRlbnNpb25TdGF0ZXMudHlwZSA9PT0gRXh0ZW5zaW9uUm91dGVyU3RhdHVzLldBTExFVF9DT05ORUNURUQgJiZcbiAgICAgICAgICBBY2NBZGRyZXNzLnZhbGlkYXRlKGV4dGVuc2lvblN0YXRlcy53YWxsZXQudGVycmFBZGRyZXNzKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh7XG4gICAgICAgICAgICBzdGF0dXM6IFdhbGxldFN0YXR1cy5XQUxMRVRfQ09OTkVDVEVELFxuICAgICAgICAgICAgbmV0d29yazogZXh0ZW5zaW9uU3RhdGVzLm5ldHdvcmssXG4gICAgICAgICAgICB3YWxsZXRzOiBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBjb25uZWN0VHlwZTogQ29ubmVjdFR5cGUuRVhURU5TSU9OLFxuICAgICAgICAgICAgICAgIHRlcnJhQWRkcmVzczogZXh0ZW5zaW9uU3RhdGVzLndhbGxldC50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgZGVzaWduOiBleHRlbnNpb25TdGF0ZXMud2FsbGV0LmRlc2lnbixcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBzdXBwb3J0RmVhdHVyZXM6IGV4dGVuc2lvblN0YXRlcy5zdXBwb3J0RmVhdHVyZXMsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZXModGhpcy5fbm90Q29ubmVjdGVkKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHRoaXMuZGlzYWJsZUV4dGVuc2lvbiA9ICgpID0+IHtcbiAgICAgIHRoaXMuZXh0ZW5zaW9uPy5kaXNjb25uZWN0KCk7XG4gICAgICBleHRlbnNpb25TdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMuZGlzYWJsZUV4dGVuc2lvbiA9IG51bGw7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIGVuYWJsZVdhbGxldENvbm5lY3QgPSAod2FsbGV0Q29ubmVjdDogV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIpID0+IHtcbiAgICB0aGlzLmRpc2FibGVSZWFkb25seVdhbGxldD8uKCk7XG4gICAgdGhpcy5kaXNhYmxlRXh0ZW5zaW9uPy4oKTtcblxuICAgIGlmICh0aGlzLndhbGxldENvbm5lY3QgPT09IHdhbGxldENvbm5lY3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy53YWxsZXRDb25uZWN0KSB7XG4gICAgICB0aGlzLndhbGxldENvbm5lY3QuZGlzY29ubmVjdCgpO1xuICAgIH1cblxuICAgIHRoaXMud2FsbGV0Q29ubmVjdCA9IHdhbGxldENvbm5lY3Q7XG5cbiAgICBjb25zdCBzdWJzY3JpYmVXYWxsZXRDb25uZWN0ID0gKFxuICAgICAgd2M6IFdhbGxldENvbm5lY3RDb250cm9sbGVyLFxuICAgICk6IFN1YnNjcmlwdGlvbiA9PiB7XG4gICAgICByZXR1cm4gd2Muc2Vzc2lvbigpLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IChzdGF0dXMpID0+IHtcbiAgICAgICAgICBzd2l0Y2ggKHN0YXR1cy5zdGF0dXMpIHtcbiAgICAgICAgICAgIGNhc2UgV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMuQ09OTkVDVEVEOlxuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh7XG4gICAgICAgICAgICAgICAgc3RhdHVzOiBXYWxsZXRTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCxcbiAgICAgICAgICAgICAgICBuZXR3b3JrOlxuICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLndhbGxldENvbm5lY3RDaGFpbklkc1tzdGF0dXMuY2hhaW5JZF0gPz9cbiAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgICAgICAgICB3YWxsZXRzOiBbXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RUeXBlOiBDb25uZWN0VHlwZS5XQUxMRVRDT05ORUNULFxuICAgICAgICAgICAgICAgICAgICB0ZXJyYUFkZHJlc3M6IHN0YXR1cy50ZXJyYUFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgIGRlc2lnbjogJ3dhbGxldGNvbm5lY3QnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIHN1cHBvcnRGZWF0dXJlczogV0FMTEVUQ09OTkVDVF9TVVBQT1JUX0ZFQVRVUkVTLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlcyh0aGlzLl9ub3RDb25uZWN0ZWQpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgY29uc3Qgd2FsbGV0Q29ubmVjdFNlc3Npb25TdWJzY3JpcHRpb24gPVxuICAgICAgc3Vic2NyaWJlV2FsbGV0Q29ubmVjdCh3YWxsZXRDb25uZWN0KTtcblxuICAgIHRoaXMuZGlzYWJsZVdhbGxldENvbm5lY3QgPSAoKSA9PiB7XG4gICAgICB0aGlzLndhbGxldENvbm5lY3Q/LmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMud2FsbGV0Q29ubmVjdCA9IG51bGw7XG4gICAgICB3YWxsZXRDb25uZWN0U2Vzc2lvblN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5kaXNhYmxlV2FsbGV0Q29ubmVjdCA9IG51bGw7XG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==