"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@walletconnect/utils");
const network_1 = __importDefault(require("./network"));
// @ts-ignore
const WS = typeof global.WebSocket !== 'undefined' ? global.WebSocket : require('ws');
// -- SocketTransport ------------------------------------------------------ //
class SocketTransport {
    // -- constructor ----------------------------------------------------- //
    constructor(opts) {
        this.opts = opts;
        this._queue = [];
        this._events = [];
        this._subscriptions = [];
        // -- public ---------------------------------------------------------- //
        this.open = () => {
            this._socketCreate();
        };
        this.close = () => {
            this._socketClose();
        };
        this.send = (message, topic, silent) => {
            if (!topic || typeof topic !== 'string') {
                throw new Error('Missing or invalid topic field');
            }
            this._socketSend({
                topic: topic,
                type: 'pub',
                payload: message,
                silent: !!silent,
            });
        };
        this.subscribe = (topic) => {
            this._socketSend({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            });
        };
        this.on = (event, callback) => {
            this._events.push({ event, callback });
        };
        // -- private ---------------------------------------------------------- //
        this._socketCreate = () => {
            if (this._nextSocket) {
                return;
            }
            const url = getWebSocketUrl(this._url, this._protocol, this._version);
            this._nextSocket = new WS(url);
            if (!this._nextSocket) {
                throw new Error('Failed to create socket');
            }
            this._nextSocket.onmessage = (event) => this._socketReceive(event);
            this._nextSocket.onopen = () => this._socketOpen();
            this._nextSocket.onerror = (event) => this._socketError(event);
            this._nextSocket.onclose = () => {
                this._nextSocket = null;
                setTimeout(this._socketCreate, 500);
            };
        };
        this._socketOpen = () => {
            this._socketClose();
            this._socket = this._nextSocket;
            this._nextSocket = null;
            this._queueSubscriptions();
            this._pushQueue();
        };
        this._socketClose = () => {
            if (this._socket) {
                this._socket.onclose = () => {
                    // empty
                };
                this._socket.close();
            }
        };
        this._socketSend = (socketMessage) => {
            const message = JSON.stringify(socketMessage);
            if (this._socket && this._socket.readyState === 1) {
                this._socket.send(message);
            }
            else {
                this._setToQueue(socketMessage);
                this._socketCreate();
            }
        };
        this._socketReceive = async (event) => {
            let socketMessage;
            try {
                socketMessage = JSON.parse(event.data);
            }
            catch (error) {
                return;
            }
            this._socketSend({
                topic: socketMessage.topic,
                type: 'ack',
                payload: '',
                silent: true,
            });
            if (this._socket && this._socket.readyState === 1) {
                const events = this._events.filter((itemEvent) => itemEvent.event === 'message');
                if (events && events.length) {
                    events.forEach((itemEvent) => itemEvent.callback(socketMessage));
                }
            }
        };
        this._socketError = (e) => {
            const events = this._events.filter((event) => event.event === 'error');
            if (events && events.length) {
                events.forEach((event) => event.callback(e));
            }
        };
        this._queueSubscriptions = () => {
            const subscriptions = this._subscriptions;
            subscriptions.forEach((topic) => this._queue.push({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            }));
            this._subscriptions = this.opts.subscriptions || [];
        };
        this._setToQueue = (socketMessage) => {
            this._queue.push(socketMessage);
        };
        this._pushQueue = () => {
            const queue = this._queue;
            queue.forEach((socketMessage) => this._socketSend(socketMessage));
            this._queue = [];
        };
        this._protocol = opts.protocol;
        this._version = opts.version;
        this._url = '';
        this._netMonitor = null;
        this._socket = null;
        this._nextSocket = null;
        this._subscriptions = opts.subscriptions || [];
        this._netMonitor = opts.netMonitor || new network_1.default();
        if (!opts.url || typeof opts.url !== 'string') {
            throw new Error('Missing or invalid WebSocket url');
        }
        this._url = opts.url;
        this._netMonitor.on('online', () => this._socketCreate());
    }
    set readyState(value) {
        // empty
    }
    get readyState() {
        return this._socket ? this._socket.readyState : -1;
    }
    set connecting(value) {
        // empty
    }
    get connecting() {
        return this.readyState === 0;
    }
    set connected(value) {
        // empty
    }
    get connected() {
        return this.readyState === 1;
    }
    set closing(value) {
        // empty
    }
    get closing() {
        return this.readyState === 2;
    }
    set closed(value) {
        // empty
    }
    get closed() {
        return this.readyState === 3;
    }
}
function getWebSocketUrl(webUrl, protocol, version) {
    var _a, _b;
    const url = webUrl.startsWith('https')
        ? webUrl.replace('https', 'wss')
        : webUrl.startsWith('http')
            ? webUrl.replace('http', 'ws')
            : webUrl;
    const splitUrl = url.split('?');
    const params = (0, utils_1.isBrowser)()
        ? {
            protocol,
            version,
            env: 'browser',
            host: ((_a = (0, utils_1.getLocation)()) === null || _a === void 0 ? void 0 : _a.host) || '',
        }
        : {
            protocol,
            version,
            env: ((_b = (0, utils_1.detectEnv)()) === null || _b === void 0 ? void 0 : _b.name) || '',
        };
    const queryString = (0, utils_1.appendToQueryString)((0, utils_1.getQueryString)(splitUrl[1] || ''), params);
    return splitUrl[0] + '?' + queryString;
}
exports.default = SocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvQHRlcnJhLW1vbmV5L3dhbGxldC1wcm92aWRlci9tb2R1bGVzL3dhbGxldGNvbm5lY3QvaW1wbC9zb2NrZXQtdHJhbnNwb3J0L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBT0EsZ0RBTThCO0FBRTlCLHdEQUF1QztBQUV2QyxhQUFhO0FBQ2IsTUFBTSxFQUFFLEdBQ04sT0FBTyxNQUFNLENBQUMsU0FBUyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRTdFLCtFQUErRTtBQUUvRSxNQUFNLGVBQWU7SUFXbkIsMEVBQTBFO0lBRTFFLFlBQW9CLElBQTZCO1FBQTdCLFNBQUksR0FBSixJQUFJLENBQXlCO1FBTnpDLFdBQU0sR0FBcUIsRUFBRSxDQUFDO1FBQzlCLFlBQU8sR0FBc0IsRUFBRSxDQUFDO1FBQ2hDLG1CQUFjLEdBQWEsRUFBRSxDQUFDO1FBK0R0QywwRUFBMEU7UUFFbkUsU0FBSSxHQUFHLEdBQUcsRUFBRTtZQUNqQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdkIsQ0FBQyxDQUFDO1FBRUssVUFBSyxHQUFHLEdBQUcsRUFBRTtZQUNsQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEIsQ0FBQyxDQUFDO1FBRUssU0FBSSxHQUFHLENBQUMsT0FBZSxFQUFFLEtBQWMsRUFBRSxNQUFnQixFQUFRLEVBQUU7WUFDeEUsSUFBSSxDQUFDLEtBQUssSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7Z0JBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzthQUNuRDtZQUVELElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsS0FBSyxFQUFFLEtBQUs7Z0JBQ1osSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsT0FBTyxFQUFFLE9BQU87Z0JBQ2hCLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTTthQUNqQixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFFSyxjQUFTLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRTtZQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDO2dCQUNmLEtBQUssRUFBRSxLQUFLO2dCQUNaLElBQUksRUFBRSxLQUFLO2dCQUNYLE9BQU8sRUFBRSxFQUFFO2dCQUNYLE1BQU0sRUFBRSxJQUFJO2FBQ2IsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBRUssT0FBRSxHQUFHLENBQUMsS0FBYSxFQUFFLFFBQWdDLEVBQUUsRUFBRTtZQUM5RCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQztRQUVGLDJFQUEyRTtRQUVuRSxrQkFBYSxHQUFHLEdBQUcsRUFBRTtZQUMzQixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3BCLE9BQU87YUFDUjtZQUVELE1BQU0sR0FBRyxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXRFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQzthQUM1QztZQUVELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxHQUFHLENBQUMsS0FBbUIsRUFBRSxFQUFFLENBQ25ELElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBRW5ELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3RDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQztRQUVNLGdCQUFXLEdBQUcsR0FBRyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDaEMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3BCLENBQUMsQ0FBQztRQUVNLGlCQUFZLEdBQUcsR0FBRyxFQUFFO1lBQzFCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO29CQUMxQixRQUFRO2dCQUNWLENBQUMsQ0FBQztnQkFDRixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ3RCO1FBQ0gsQ0FBQyxDQUFDO1FBRU0sZ0JBQVcsR0FBRyxDQUFDLGFBQTZCLEVBQUUsRUFBRTtZQUN0RCxNQUFNLE9BQU8sR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRXRELElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsS0FBSyxDQUFDLEVBQUU7Z0JBQ2pELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzVCO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUN0QjtRQUNILENBQUMsQ0FBQztRQUVNLG1CQUFjLEdBQUcsS0FBSyxFQUFFLEtBQW1CLEVBQUUsRUFBRTtZQUNyRCxJQUFJLGFBQTZCLENBQUM7WUFFbEMsSUFBSTtnQkFDRixhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDeEM7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZCxPQUFPO2FBQ1I7WUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDO2dCQUNmLEtBQUssRUFBRSxhQUFhLENBQUMsS0FBSztnQkFDMUIsSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsTUFBTSxFQUFFLElBQUk7YUFDYixDQUFDLENBQUM7WUFFSCxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEtBQUssQ0FBQyxFQUFFO2dCQUNqRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FDaEMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUM3QyxDQUFDO2dCQUNGLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUU7b0JBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztpQkFDbEU7YUFDRjtRQUNILENBQUMsQ0FBQztRQUVNLGlCQUFZLEdBQUcsQ0FBQyxDQUFRLEVBQUUsRUFBRTtZQUNsQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssS0FBSyxPQUFPLENBQUMsQ0FBQztZQUN2RSxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUMzQixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDOUM7UUFDSCxDQUFDLENBQUM7UUFFTSx3QkFBbUIsR0FBRyxHQUFHLEVBQUU7WUFDakMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUUxQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBYSxFQUFFLEVBQUUsQ0FDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQ2YsS0FBSyxFQUFFLEtBQUs7Z0JBQ1osSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsTUFBTSxFQUFFLElBQUk7YUFDYixDQUFDLENBQ0gsQ0FBQztZQUVGLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLElBQUksRUFBRSxDQUFDO1FBQ3RELENBQUMsQ0FBQztRQUVNLGdCQUFXLEdBQUcsQ0FBQyxhQUE2QixFQUFFLEVBQUU7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDO1FBRU0sZUFBVSxHQUFHLEdBQUcsRUFBRTtZQUN4QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBRTFCLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUE2QixFQUFFLEVBQUUsQ0FDOUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FDaEMsQ0FBQztZQUVGLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ25CLENBQUMsQ0FBQztRQWxOQSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztRQUMvQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxpQkFBYyxFQUFFLENBQUM7UUFFM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksT0FBTyxJQUFJLENBQUMsR0FBRyxLQUFLLFFBQVEsRUFBRTtZQUM3QyxNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7U0FDckQ7UUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFFckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRCxJQUFJLFVBQVUsQ0FBQyxLQUFLO1FBQ2xCLFFBQVE7SUFDVixDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELElBQUksVUFBVSxDQUFDLEtBQUs7UUFDbEIsUUFBUTtJQUNWLENBQUM7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxVQUFVLEtBQUssQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxJQUFJLFNBQVMsQ0FBQyxLQUFLO1FBQ2pCLFFBQVE7SUFDVixDQUFDO0lBRUQsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMsVUFBVSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxPQUFPLENBQUMsS0FBSztRQUNmLFFBQVE7SUFDVixDQUFDO0lBRUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsVUFBVSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxNQUFNLENBQUMsS0FBSztRQUNkLFFBQVE7SUFDVixDQUFDO0lBRUQsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsVUFBVSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBMkpGO0FBRUQsU0FBUyxlQUFlLENBQ3RCLE1BQWMsRUFDZCxRQUFnQixFQUNoQixPQUFlOztJQUVmLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUM7UUFDaEMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQzNCLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUM7WUFDOUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNYLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBQSxpQkFBUyxHQUFFO1FBQ3hCLENBQUMsQ0FBQztZQUNFLFFBQVE7WUFDUixPQUFPO1lBQ1AsR0FBRyxFQUFFLFNBQVM7WUFDZCxJQUFJLEVBQUUsQ0FBQSxNQUFBLElBQUEsbUJBQVcsR0FBRSwwQ0FBRSxJQUFJLEtBQUksRUFBRTtTQUNoQztRQUNILENBQUMsQ0FBQztZQUNFLFFBQVE7WUFDUixPQUFPO1lBQ1AsR0FBRyxFQUFFLENBQUEsTUFBQSxJQUFBLGlCQUFTLEdBQUUsMENBQUUsSUFBSSxLQUFJLEVBQUU7U0FDN0IsQ0FBQztJQUNOLE1BQU0sV0FBVyxHQUFHLElBQUEsMkJBQW1CLEVBQ3JDLElBQUEsc0JBQWMsRUFBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQ2pDLE1BQU0sQ0FDUCxDQUFDO0lBQ0YsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLFdBQVcsQ0FBQztBQUN6QyxDQUFDO0FBRUQsa0JBQWUsZUFBZSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSVNvY2tldE1lc3NhZ2UsXG4gIElUcmFuc3BvcnRFdmVudCxcbiAgSU5ldHdvcmtNb25pdG9yLFxuICBJVHJhbnNwb3J0TGliLFxuICBJU29ja2V0VHJhbnNwb3J0T3B0aW9ucyxcbn0gZnJvbSAnQHdhbGxldGNvbm5lY3QvdHlwZXMnO1xuaW1wb3J0IHtcbiAgaXNCcm93c2VyLFxuICBnZXRMb2NhdGlvbixcbiAgZ2V0UXVlcnlTdHJpbmcsXG4gIGRldGVjdEVudixcbiAgYXBwZW5kVG9RdWVyeVN0cmluZyxcbn0gZnJvbSAnQHdhbGxldGNvbm5lY3QvdXRpbHMnO1xuXG5pbXBvcnQgTmV0d29ya01vbml0b3IgZnJvbSAnLi9uZXR3b3JrJztcblxuLy8gQHRzLWlnbm9yZVxuY29uc3QgV1MgPVxuICB0eXBlb2YgZ2xvYmFsLldlYlNvY2tldCAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwuV2ViU29ja2V0IDogcmVxdWlyZSgnd3MnKTtcblxuLy8gLS0gU29ja2V0VHJhbnNwb3J0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG5jbGFzcyBTb2NrZXRUcmFuc3BvcnQgaW1wbGVtZW50cyBJVHJhbnNwb3J0TGliIHtcbiAgcHJpdmF0ZSBfcHJvdG9jb2w6IHN0cmluZztcbiAgcHJpdmF0ZSBfdmVyc2lvbjogbnVtYmVyO1xuICBwcml2YXRlIF91cmw6IHN0cmluZztcbiAgcHJpdmF0ZSBfbmV0TW9uaXRvcjogSU5ldHdvcmtNb25pdG9yIHwgbnVsbDtcbiAgcHJpdmF0ZSBfc29ja2V0OiBXZWJTb2NrZXQgfCBudWxsO1xuICBwcml2YXRlIF9uZXh0U29ja2V0OiBXZWJTb2NrZXQgfCBudWxsO1xuICBwcml2YXRlIF9xdWV1ZTogSVNvY2tldE1lc3NhZ2VbXSA9IFtdO1xuICBwcml2YXRlIF9ldmVudHM6IElUcmFuc3BvcnRFdmVudFtdID0gW107XG4gIHByaXZhdGUgX3N1YnNjcmlwdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgLy8gLS0gY29uc3RydWN0b3IgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdHM6IElTb2NrZXRUcmFuc3BvcnRPcHRpb25zKSB7XG4gICAgdGhpcy5fcHJvdG9jb2wgPSBvcHRzLnByb3RvY29sO1xuICAgIHRoaXMuX3ZlcnNpb24gPSBvcHRzLnZlcnNpb247XG4gICAgdGhpcy5fdXJsID0gJyc7XG4gICAgdGhpcy5fbmV0TW9uaXRvciA9IG51bGw7XG4gICAgdGhpcy5fc29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gb3B0cy5zdWJzY3JpcHRpb25zIHx8IFtdO1xuICAgIHRoaXMuX25ldE1vbml0b3IgPSBvcHRzLm5ldE1vbml0b3IgfHwgbmV3IE5ldHdvcmtNb25pdG9yKCk7XG5cbiAgICBpZiAoIW9wdHMudXJsIHx8IHR5cGVvZiBvcHRzLnVybCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBvciBpbnZhbGlkIFdlYlNvY2tldCB1cmwnKTtcbiAgICB9XG5cbiAgICB0aGlzLl91cmwgPSBvcHRzLnVybDtcblxuICAgIHRoaXMuX25ldE1vbml0b3Iub24oJ29ubGluZScsICgpID0+IHRoaXMuX3NvY2tldENyZWF0ZSgpKTtcbiAgfVxuXG4gIHNldCByZWFkeVN0YXRlKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCByZWFkeVN0YXRlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3NvY2tldCA/IHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlIDogLTE7XG4gIH1cblxuICBzZXQgY29ubmVjdGluZyh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY29ubmVjdGluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAwO1xuICB9XG5cbiAgc2V0IGNvbm5lY3RlZCh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY29ubmVjdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDE7XG4gIH1cblxuICBzZXQgY2xvc2luZyh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY2xvc2luZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAyO1xuICB9XG5cbiAgc2V0IGNsb3NlZCh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY2xvc2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDM7XG4gIH1cblxuICAvLyAtLSBwdWJsaWMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG4gIHB1YmxpYyBvcGVuID0gKCkgPT4ge1xuICAgIHRoaXMuX3NvY2tldENyZWF0ZSgpO1xuICB9O1xuXG4gIHB1YmxpYyBjbG9zZSA9ICgpID0+IHtcbiAgICB0aGlzLl9zb2NrZXRDbG9zZSgpO1xuICB9O1xuXG4gIHB1YmxpYyBzZW5kID0gKG1lc3NhZ2U6IHN0cmluZywgdG9waWM/OiBzdHJpbmcsIHNpbGVudD86IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICBpZiAoIXRvcGljIHx8IHR5cGVvZiB0b3BpYyAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBvciBpbnZhbGlkIHRvcGljIGZpZWxkJyk7XG4gICAgfVxuXG4gICAgdGhpcy5fc29ja2V0U2VuZCh7XG4gICAgICB0b3BpYzogdG9waWMsXG4gICAgICB0eXBlOiAncHViJyxcbiAgICAgIHBheWxvYWQ6IG1lc3NhZ2UsXG4gICAgICBzaWxlbnQ6ICEhc2lsZW50LFxuICAgIH0pO1xuICB9O1xuXG4gIHB1YmxpYyBzdWJzY3JpYmUgPSAodG9waWM6IHN0cmluZykgPT4ge1xuICAgIHRoaXMuX3NvY2tldFNlbmQoe1xuICAgICAgdG9waWM6IHRvcGljLFxuICAgICAgdHlwZTogJ3N1YicsXG4gICAgICBwYXlsb2FkOiAnJyxcbiAgICAgIHNpbGVudDogdHJ1ZSxcbiAgICB9KTtcbiAgfTtcblxuICBwdWJsaWMgb24gPSAoZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IChwYXlsb2FkOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICB0aGlzLl9ldmVudHMucHVzaCh7IGV2ZW50LCBjYWxsYmFjayB9KTtcbiAgfTtcblxuICAvLyAtLSBwcml2YXRlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuICBwcml2YXRlIF9zb2NrZXRDcmVhdGUgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuX25leHRTb2NrZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB1cmwgPSBnZXRXZWJTb2NrZXRVcmwodGhpcy5fdXJsLCB0aGlzLl9wcm90b2NvbCwgdGhpcy5fdmVyc2lvbik7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbmV3IFdTKHVybCk7XG5cbiAgICBpZiAoIXRoaXMuX25leHRTb2NrZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBzb2NrZXQnKTtcbiAgICB9XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9ubWVzc2FnZSA9IChldmVudDogTWVzc2FnZUV2ZW50KSA9PlxuICAgICAgdGhpcy5fc29ja2V0UmVjZWl2ZShldmVudCk7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9ub3BlbiA9ICgpID0+IHRoaXMuX3NvY2tldE9wZW4oKTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQub25lcnJvciA9IChldmVudDogRXZlbnQpID0+IHRoaXMuX3NvY2tldEVycm9yKGV2ZW50KTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQub25jbG9zZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuX25leHRTb2NrZXQgPSBudWxsO1xuICAgICAgc2V0VGltZW91dCh0aGlzLl9zb2NrZXRDcmVhdGUsIDUwMCk7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRPcGVuID0gKCkgPT4ge1xuICAgIHRoaXMuX3NvY2tldENsb3NlKCk7XG4gICAgdGhpcy5fc29ja2V0ID0gdGhpcy5fbmV4dFNvY2tldDtcbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9xdWV1ZVN1YnNjcmlwdGlvbnMoKTtcbiAgICB0aGlzLl9wdXNoUXVldWUoKTtcbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRDbG9zZSA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5fc29ja2V0KSB7XG4gICAgICB0aGlzLl9zb2NrZXQub25jbG9zZSA9ICgpID0+IHtcbiAgICAgICAgLy8gZW1wdHlcbiAgICAgIH07XG4gICAgICB0aGlzLl9zb2NrZXQuY2xvc2UoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0U2VuZCA9IChzb2NrZXRNZXNzYWdlOiBJU29ja2V0TWVzc2FnZSkgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2U6IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHNvY2tldE1lc3NhZ2UpO1xuXG4gICAgaWYgKHRoaXMuX3NvY2tldCAmJiB0aGlzLl9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgdGhpcy5fc29ja2V0LnNlbmQobWVzc2FnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3NldFRvUXVldWUoc29ja2V0TWVzc2FnZSk7XG4gICAgICB0aGlzLl9zb2NrZXRDcmVhdGUoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0UmVjZWl2ZSA9IGFzeW5jIChldmVudDogTWVzc2FnZUV2ZW50KSA9PiB7XG4gICAgbGV0IHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlO1xuXG4gICAgdHJ5IHtcbiAgICAgIHNvY2tldE1lc3NhZ2UgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fc29ja2V0U2VuZCh7XG4gICAgICB0b3BpYzogc29ja2V0TWVzc2FnZS50b3BpYyxcbiAgICAgIHR5cGU6ICdhY2snLFxuICAgICAgcGF5bG9hZDogJycsXG4gICAgICBzaWxlbnQ6IHRydWUsXG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5fc29ja2V0ICYmIHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICBjb25zdCBldmVudHMgPSB0aGlzLl9ldmVudHMuZmlsdGVyKFxuICAgICAgICAoaXRlbUV2ZW50KSA9PiBpdGVtRXZlbnQuZXZlbnQgPT09ICdtZXNzYWdlJyxcbiAgICAgICk7XG4gICAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgZXZlbnRzLmZvckVhY2goKGl0ZW1FdmVudCkgPT4gaXRlbUV2ZW50LmNhbGxiYWNrKHNvY2tldE1lc3NhZ2UpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0RXJyb3IgPSAoZTogRXZlbnQpID0+IHtcbiAgICBjb25zdCBldmVudHMgPSB0aGlzLl9ldmVudHMuZmlsdGVyKChldmVudCkgPT4gZXZlbnQuZXZlbnQgPT09ICdlcnJvcicpO1xuICAgIGlmIChldmVudHMgJiYgZXZlbnRzLmxlbmd0aCkge1xuICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PiBldmVudC5jYWxsYmFjayhlKSk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgX3F1ZXVlU3Vic2NyaXB0aW9ucyA9ICgpID0+IHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gdGhpcy5fc3Vic2NyaXB0aW9ucztcblxuICAgIHN1YnNjcmlwdGlvbnMuZm9yRWFjaCgodG9waWM6IHN0cmluZykgPT5cbiAgICAgIHRoaXMuX3F1ZXVlLnB1c2goe1xuICAgICAgICB0b3BpYzogdG9waWMsXG4gICAgICAgIHR5cGU6ICdzdWInLFxuICAgICAgICBwYXlsb2FkOiAnJyxcbiAgICAgICAgc2lsZW50OiB0cnVlLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB0aGlzLm9wdHMuc3Vic2NyaXB0aW9ucyB8fCBbXTtcbiAgfTtcblxuICBwcml2YXRlIF9zZXRUb1F1ZXVlID0gKHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlKSA9PiB7XG4gICAgdGhpcy5fcXVldWUucHVzaChzb2NrZXRNZXNzYWdlKTtcbiAgfTtcblxuICBwcml2YXRlIF9wdXNoUXVldWUgPSAoKSA9PiB7XG4gICAgY29uc3QgcXVldWUgPSB0aGlzLl9xdWV1ZTtcblxuICAgIHF1ZXVlLmZvckVhY2goKHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlKSA9PlxuICAgICAgdGhpcy5fc29ja2V0U2VuZChzb2NrZXRNZXNzYWdlKSxcbiAgICApO1xuXG4gICAgdGhpcy5fcXVldWUgPSBbXTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0V2ViU29ja2V0VXJsKFxuICB3ZWJVcmw6IHN0cmluZyxcbiAgcHJvdG9jb2w6IHN0cmluZyxcbiAgdmVyc2lvbjogbnVtYmVyLFxuKTogc3RyaW5nIHtcbiAgY29uc3QgdXJsID0gd2ViVXJsLnN0YXJ0c1dpdGgoJ2h0dHBzJylcbiAgICA/IHdlYlVybC5yZXBsYWNlKCdodHRwcycsICd3c3MnKVxuICAgIDogd2ViVXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKVxuICAgID8gd2ViVXJsLnJlcGxhY2UoJ2h0dHAnLCAnd3MnKVxuICAgIDogd2ViVXJsO1xuICBjb25zdCBzcGxpdFVybCA9IHVybC5zcGxpdCgnPycpO1xuICBjb25zdCBwYXJhbXMgPSBpc0Jyb3dzZXIoKVxuICAgID8ge1xuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgZW52OiAnYnJvd3NlcicsXG4gICAgICAgIGhvc3Q6IGdldExvY2F0aW9uKCk/Lmhvc3QgfHwgJycsXG4gICAgICB9XG4gICAgOiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICBlbnY6IGRldGVjdEVudigpPy5uYW1lIHx8ICcnLFxuICAgICAgfTtcbiAgY29uc3QgcXVlcnlTdHJpbmcgPSBhcHBlbmRUb1F1ZXJ5U3RyaW5nKFxuICAgIGdldFF1ZXJ5U3RyaW5nKHNwbGl0VXJsWzFdIHx8ICcnKSxcbiAgICBwYXJhbXMsXG4gICk7XG4gIHJldHVybiBzcGxpdFVybFswXSArICc/JyArIHF1ZXJ5U3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBTb2NrZXRUcmFuc3BvcnQ7XG4iXX0=