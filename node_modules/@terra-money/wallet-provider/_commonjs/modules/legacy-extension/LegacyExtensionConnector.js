"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LegacyExtensionConnector = void 0;
const web_extension_interface_1 = require("@terra-dev/web-extension-interface");
const terra_js_1 = require("@terra-money/terra.js");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const createFixedExtension_1 = require("./createFixedExtension");
const supportFeatures = ['post', 'sign'];
class LegacyExtensionConnector {
    constructor(identifier) {
        this.identifier = identifier;
        this.hostWindow = null;
        this.statesSubscription = null;
        this.open = (hostWindow, statesObserver) => {
            this.hostWindow = hostWindow;
            this.statesSubscription = this._states
                .pipe((0, operators_1.filter)((states) => !!states))
                .subscribe(statesObserver);
            this.refetchStates();
        };
        this.close = () => {
            this._extension.disconnect();
        };
        this.requestApproval = () => {
            this.recheckStates();
        };
        this.refetchStates = () => {
            this.recheckStates();
        };
        this.post = (terraAddress, tx) => {
            const subject = new rxjs_1.BehaviorSubject({
                status: web_extension_interface_1.WebExtensionTxStatus.PROGRESS,
            });
            this._extension
                .post(tx)
                .then(({ payload }) => {
                subject.next({
                    status: web_extension_interface_1.WebExtensionTxStatus.SUCCEED,
                    payload: payload.result,
                });
                subject.complete();
            })
                .catch((error) => subject.error(error));
            return subject.asObservable();
        };
        this.sign = (terraAddress, tx) => {
            const subject = new rxjs_1.BehaviorSubject({
                status: web_extension_interface_1.WebExtensionTxStatus.PROGRESS,
            });
            this._extension
                .sign(tx)
                .then(({ payload }) => {
                subject.next({
                    status: web_extension_interface_1.WebExtensionTxStatus.SUCCEED,
                    payload: payload.result,
                });
                subject.complete();
            })
                .catch((error) => subject.error(error));
            return subject.asObservable();
        };
        this.signBytes = () => {
            throw new Error('[LegacyExtensionConnector] does not support signBytes()');
        };
        this.hasCW20Tokens = () => {
            throw new Error('[LegacyExtensionConnector] does not support hasCW20Tokens()');
        };
        this.addCW20Tokens = () => {
            throw new Error('[LegacyExtensionConnector] does not support addCW20Tokens()');
        };
        this.hasNetwork = () => {
            throw new Error('[LegacyExtensionConnector] does not support hasNetwork()');
        };
        this.addNetwork = () => {
            throw new Error('[LegacyExtensionConnector] does not support addNetwork()');
        };
        // ---------------------------------------------
        // internal
        // ---------------------------------------------
        this.recheckStates = async () => {
            if (this._extension.inTransactionProgress()) {
                return;
            }
            const infoResult = await this._extension.info();
            const connectResult = await this._extension.connect();
            if (connectResult.address && terra_js_1.AccAddress.validate(connectResult.address)) {
                this._states.next({
                    type: web_extension_interface_1.WebExtensionStatus.READY,
                    network: infoResult,
                    focusedWalletAddress: connectResult.address,
                    wallets: [
                        {
                            name: '',
                            terraAddress: connectResult.address,
                            design: 'terra',
                        },
                    ],
                });
            }
            else {
                this._states.next({
                    type: web_extension_interface_1.WebExtensionStatus.READY,
                    network: infoResult,
                    focusedWalletAddress: undefined,
                    wallets: [],
                });
            }
        };
        this._states = new rxjs_1.BehaviorSubject({
            type: web_extension_interface_1.WebExtensionStatus.INITIALIZING,
        });
        this._extension = (0, createFixedExtension_1.createFixedExtension)(identifier);
    }
    supportFeatures() {
        return supportFeatures;
    }
}
exports.LegacyExtensionConnector = LegacyExtensionConnector;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL0B0ZXJyYS1tb25leS93YWxsZXQtcHJvdmlkZXIvbW9kdWxlcy9sZWdhY3ktZXh0ZW5zaW9uL0xlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxnRkFTNEM7QUFDNUMsb0RBQW9FO0FBRXBFLCtCQUE2RTtBQUM3RSw4Q0FBd0M7QUFDeEMsaUVBQThFO0FBRTlFLE1BQU0sZUFBZSxHQUFnQyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUV0RSxNQUFhLHdCQUF3QjtJQVVuQyxZQUFvQixVQUFrQjtRQUFsQixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBUDlCLGVBQVUsR0FBa0IsSUFBSSxDQUFDO1FBQ2pDLHVCQUFrQixHQUF3QixJQUFJLENBQUM7UUFjdkQsU0FBSSxHQUFHLENBQUMsVUFBa0IsRUFBRSxjQUE0QyxFQUFFLEVBQUU7WUFDMUUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7WUFDN0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxPQUFPO2lCQUNuQyxJQUFJLENBQ0gsSUFBQSxrQkFBTSxFQUNKLENBQUMsTUFBaUMsRUFBZ0MsRUFBRSxDQUNsRSxDQUFDLENBQUMsTUFBTSxDQUNYLENBQ0Y7aUJBQ0EsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRTdCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFFRixVQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ1gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUMvQixDQUFDLENBQUM7UUFFRixvQkFBZSxHQUFHLEdBQUcsRUFBRTtZQUNyQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdkIsQ0FBQyxDQUFDO1FBRUYsa0JBQWEs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QUkscUJBQVUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUN2RSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztvQkFDaEIsSUFBSSxFQUFFLDRDQUFrQixDQUFDLEtBQUs7b0JBQzlCLE9BQU8sRUFBRSxVQUFVO29CQUNuQixvQkFBb0IsRUFBRSxhQUFhLENBQUMsT0FBTztvQkFDM0MsT0FBTyxFQUFFO3dCQUNQOzRCQUNFLElBQUksRUFBRSxFQUFFOzRCQUNSLFlBQVksRUFBRSxhQUFhLENBQUMsT0FBTzs0QkFDbkMsTUFBTSxFQUFFLE9BQU87eUJBQ2hCO3FCQUNGO2lCQUNGLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNoQixJQUFJLEVBQUUsNENBQWtCLENBQUMsS0FBSztvQkFDOUIsT0FBTyxFQUFFLFVBQVU7b0JBQ25CLG9CQUFvQixFQUFFLFNBQVM7b0JBQy9CLE9BQU8sRUFBRSxFQUFFO2lCQUNaLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDO1FBeklBLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxzQkFBZSxDQUFxQjtZQUNyRCxJQUFJLEVBQUUsNENBQWtCLENBQUMsWUFBWTtTQUN0QyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUEsMkNBQW9CLEVBQUMsVUFBVSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQVZELGVBQWU7UUFDYixPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0NBNklGO0FBckpELDREQXFKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFRlcnJhV2ViRXh0ZW5zaW9uQ29ubmVjdG9yLFxuICBUZXJyYVdlYkV4dGVuc2lvbkZlYXR1cmVzLFxuICBXZWJFeHRlbnNpb25Qb3N0UGF5bG9hZCxcbiAgV2ViRXh0ZW5zaW9uU2lnblBheWxvYWQsXG4gIFdlYkV4dGVuc2lvblN0YXRlcyxcbiAgV2ViRXh0ZW5zaW9uU3RhdHVzLFxuICBXZWJFeHRlbnNpb25UeFJlc3VsdCxcbiAgV2ViRXh0ZW5zaW9uVHhTdGF0dXMsXG59IGZyb20gJ0B0ZXJyYS1kZXYvd2ViLWV4dGVuc2lvbi1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQWNjQWRkcmVzcywgQ3JlYXRlVHhPcHRpb25zIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3RlcnJhLmpzJztcbmltcG9ydCB7IE5ldHdvcmtJbmZvIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3VzZS13YWxsZXQnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZlciwgU3Vic2NyaWJhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGNyZWF0ZUZpeGVkRXh0ZW5zaW9uLCBGaXhlZEV4dGVuc2lvbiB9IGZyb20gJy4vY3JlYXRlRml4ZWRFeHRlbnNpb24nO1xuXG5jb25zdCBzdXBwb3J0RmVhdHVyZXM6IFRlcnJhV2ViRXh0ZW5zaW9uRmVhdHVyZXNbXSA9IFsncG9zdCcsICdzaWduJ107XG5cbmV4cG9ydCBjbGFzcyBMZWdhY3lFeHRlbnNpb25Db25uZWN0b3IgaW1wbGVtZW50cyBUZXJyYVdlYkV4dGVuc2lvbkNvbm5lY3RvciB7XG4gIHByaXZhdGUgX3N0YXRlczogQmVoYXZpb3JTdWJqZWN0PFdlYkV4dGVuc2lvblN0YXRlcz47XG4gIHByaXZhdGUgX2V4dGVuc2lvbjogRml4ZWRFeHRlbnNpb247XG4gIHByaXZhdGUgaG9zdFdpbmRvdzogV2luZG93IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgc3RhdGVzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gfCBudWxsID0gbnVsbDtcblxuICBzdXBwb3J0RmVhdHVyZXMoKSB7XG4gICAgcmV0dXJuIHN1cHBvcnRGZWF0dXJlcztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaWRlbnRpZmllcjogc3RyaW5nKSB7XG4gICAgdGhpcy5fc3RhdGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxXZWJFeHRlbnNpb25TdGF0ZXM+KHtcbiAgICAgIHR5cGU6IFdlYkV4dGVuc2lvblN0YXR1cy5JTklUSUFMSVpJTkcsXG4gICAgfSk7XG5cbiAgICB0aGlzLl9leHRlbnNpb24gPSBjcmVhdGVGaXhlZEV4dGVuc2lvbihpZGVudGlmaWVyKTtcbiAgfVxuXG4gIG9wZW4gPSAoaG9zdFdpbmRvdzogV2luZG93LCBzdGF0ZXNPYnNlcnZlcjogT2JzZXJ2ZXI8V2ViRXh0ZW5zaW9uU3RhdGVzPikgPT4ge1xuICAgIHRoaXMuaG9zdFdpbmRvdyA9IGhvc3RXaW5kb3c7XG4gICAgdGhpcy5zdGF0ZXNTdWJzY3JpcHRpb24gPSB0aGlzLl9zdGF0ZXNcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoXG4gICAgICAgICAgKHN0YXRlczogV2ViRXh0ZW5zaW9uU3RhdGVzIHwgbnVsbCk6IHN0YXRlcyBpcyBXZWJFeHRlbnNpb25TdGF0ZXMgPT5cbiAgICAgICAgICAgICEhc3RhdGVzLFxuICAgICAgICApLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShzdGF0ZXNPYnNlcnZlcik7XG5cbiAgICB0aGlzLnJlZmV0Y2hTdGF0ZXMoKTtcbiAgfTtcblxuICBjbG9zZSA9ICgpID0+IHtcbiAgICB0aGlzLl9leHRlbnNpb24uZGlzY29ubmVjdCgpO1xuICB9O1xuXG4gIHJlcXVlc3RBcHByb3ZhbCA9ICgpID0+IHtcbiAgICB0aGlzLnJlY2hlY2tTdGF0ZXMoKTtcbiAgfTtcblxuICByZWZldGNoU3RhdGVzID0gKCkgPT4ge1xuICAgIHRoaXMucmVjaGVja1N0YXRlcygpO1xuICB9O1xuXG4gIHBvc3QgPSAoXG4gICAgdGVycmFBZGRyZXNzOiBzdHJpbmcsXG4gICAgdHg6IENyZWF0ZVR4T3B0aW9ucyxcbiAgKTogU3Vic2NyaWJhYmxlPFdlYkV4dGVuc2lvblR4UmVzdWx0PFdlYkV4dGVuc2lvblBvc3RQYXlsb2FkPj4gPT4ge1xuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgICAgV2ViRXh0ZW5zaW9uVHhSZXN1bHQ8V2ViRXh0ZW5zaW9uUG9zdFBheWxvYWQ+XG4gICAgPih7XG4gICAgICBzdGF0dXM6IFdlYkV4dGVuc2lvblR4U3RhdHVzLlBST0dSRVNTLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uXG4gICAgICAucG9zdCh0eClcbiAgICAgIC50aGVuKCh7IHBheWxvYWQgfSkgPT4ge1xuICAgICAgICBzdWJqZWN0Lm5leHQoe1xuICAgICAgICAgIHN0YXR1czogV2ViRXh0ZW5zaW9uVHhTdGF0dXMuU1VDQ0VFRCxcbiAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLnJlc3VsdCxcbiAgICAgICAgfSk7XG4gICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiBzdWJqZWN0LmVycm9yKGVycm9yKSk7XG5cbiAgICByZXR1cm4gc3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBzaWduID0gKFxuICAgIHRlcnJhQWRkcmVzczogc3RyaW5nLFxuICAgIHR4OiBDcmVhdGVUeE9wdGlvbnMsXG4gICk6IFN1YnNjcmliYWJsZTxXZWJFeHRlbnNpb25UeFJlc3VsdDxXZWJFeHRlbnNpb25TaWduUGF5bG9hZD4+ID0+IHtcbiAgICBjb25zdCBzdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxcbiAgICAgIFdlYkV4dGVuc2lvblR4UmVzdWx0PFdlYkV4dGVuc2lvblNpZ25QYXlsb2FkPlxuICAgID4oe1xuICAgICAgc3RhdHVzOiBXZWJFeHRlbnNpb25UeFN0YXR1cy5QUk9HUkVTUyxcbiAgICB9KTtcblxuICAgIHRoaXMuX2V4dGVuc2lvblxuICAgICAgLnNpZ24odHgpXG4gICAgICAudGhlbigoeyBwYXlsb2FkIH0pID0+IHtcbiAgICAgICAgc3ViamVjdC5uZXh0KHtcbiAgICAgICAgICBzdGF0dXM6IFdlYkV4dGVuc2lvblR4U3RhdHVzLlNVQ0NFRUQsXG4gICAgICAgICAgcGF5bG9hZDogcGF5bG9hZC5yZXN1bHQsXG4gICAgICAgIH0pO1xuICAgICAgICBzdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4gc3ViamVjdC5lcnJvcihlcnJvcikpO1xuXG4gICAgcmV0dXJuIHN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgc2lnbkJ5dGVzID0gKCkgPT4ge1xuICAgIHRocm93IG5ldyBFcnJvcignW0xlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvcl0gZG9lcyBub3Qgc3VwcG9ydCBzaWduQnl0ZXMoKScpO1xuICB9O1xuXG4gIGhhc0NXMjBUb2tlbnMgPSAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ1tMZWdhY3lFeHRlbnNpb25Db25uZWN0b3JdIGRvZXMgbm90IHN1cHBvcnQgaGFzQ1cyMFRva2VucygpJyxcbiAgICApO1xuICB9O1xuXG4gIGFkZENXMjBUb2tlbnMgPSAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ1tMZWdhY3lFeHRlbnNpb25Db25uZWN0b3JdIGRvZXMgbm90IHN1cHBvcnQgYWRkQ1cyMFRva2VucygpJyxcbiAgICApO1xuICB9O1xuXG4gIGhhc05ldHdvcmsgPSAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdbTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yXSBkb2VzIG5vdCBzdXBwb3J0IGhhc05ldHdvcmsoKScpO1xuICB9O1xuXG4gIGFkZE5ldHdvcmsgPSAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdbTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yXSBkb2VzIG5vdCBzdXBwb3J0IGFkZE5ldHdvcmsoKScpO1xuICB9O1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBpbnRlcm5hbFxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgcmVjaGVja1N0YXRlcyA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAodGhpcy5fZXh0ZW5zaW9uLmluVHJhbnNhY3Rpb25Qcm9ncmVzcygpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaW5mb1Jlc3VsdDogTmV0d29ya0luZm8gPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uaW5mbygpO1xuICAgIGNvbnN0IGNvbm5lY3RSZXN1bHQ6IHsgYWRkcmVzcz86IHN0cmluZyB9ID0gYXdhaXQgdGhpcy5fZXh0ZW5zaW9uLmNvbm5lY3QoKTtcblxuICAgIGlmIChjb25uZWN0UmVzdWx0LmFkZHJlc3MgJiYgQWNjQWRkcmVzcy52YWxpZGF0ZShjb25uZWN0UmVzdWx0LmFkZHJlc3MpKSB7XG4gICAgICB0aGlzLl9zdGF0ZXMubmV4dCh7XG4gICAgICAgIHR5cGU6IFdlYkV4dGVuc2lvblN0YXR1cy5SRUFEWSxcbiAgICAgICAgbmV0d29yazogaW5mb1Jlc3VsdCxcbiAgICAgICAgZm9jdXNlZFdhbGxldEFkZHJlc3M6IGNvbm5lY3RSZXN1bHQuYWRkcmVzcyxcbiAgICAgICAgd2FsbGV0czogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIG5hbWU6ICcnLFxuICAgICAgICAgICAgdGVycmFBZGRyZXNzOiBjb25uZWN0UmVzdWx0LmFkZHJlc3MsXG4gICAgICAgICAgICBkZXNpZ246ICd0ZXJyYScsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9zdGF0ZXMubmV4dCh7XG4gICAgICAgIHR5cGU6IFdlYkV4dGVuc2lvblN0YXR1cy5SRUFEWSxcbiAgICAgICAgbmV0d29yazogaW5mb1Jlc3VsdCxcbiAgICAgICAgZm9jdXNlZFdhbGxldEFkZHJlc3M6IHVuZGVmaW5lZCxcbiAgICAgICAgd2FsbGV0czogW10sXG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG4iXX0=