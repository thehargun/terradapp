import { WebExtensionStatus, WebExtensionTxStatus, } from '@terra-dev/web-extension-interface';
import { AccAddress } from '@terra-money/terra.js';
import { BehaviorSubject } from 'rxjs';
import { filter } from 'rxjs/operators';
import { createFixedExtension } from './createFixedExtension';
const supportFeatures = ['post', 'sign'];
export class LegacyExtensionConnector {
    constructor(identifier) {
        this.identifier = identifier;
        this.hostWindow = null;
        this.statesSubscription = null;
        this.open = (hostWindow, statesObserver) => {
            this.hostWindow = hostWindow;
            this.statesSubscription = this._states
                .pipe(filter((states) => !!states))
                .subscribe(statesObserver);
            this.refetchStates();
        };
        this.close = () => {
            this._extension.disconnect();
        };
        this.requestApproval = () => {
            this.recheckStates();
        };
        this.refetchStates = () => {
            this.recheckStates();
        };
        this.post = (terraAddress, tx) => {
            const subject = new BehaviorSubject({
                status: WebExtensionTxStatus.PROGRESS,
            });
            this._extension
                .post(tx)
                .then(({ payload }) => {
                subject.next({
                    status: WebExtensionTxStatus.SUCCEED,
                    payload: payload.result,
                });
                subject.complete();
            })
                .catch((error) => subject.error(error));
            return subject.asObservable();
        };
        this.sign = (terraAddress, tx) => {
            const subject = new BehaviorSubject({
                status: WebExtensionTxStatus.PROGRESS,
            });
            this._extension
                .sign(tx)
                .then(({ payload }) => {
                subject.next({
                    status: WebExtensionTxStatus.SUCCEED,
                    payload: payload.result,
                });
                subject.complete();
            })
                .catch((error) => subject.error(error));
            return subject.asObservable();
        };
        this.signBytes = () => {
            throw new Error('[LegacyExtensionConnector] does not support signBytes()');
        };
        this.hasCW20Tokens = () => {
            throw new Error('[LegacyExtensionConnector] does not support hasCW20Tokens()');
        };
        this.addCW20Tokens = () => {
            throw new Error('[LegacyExtensionConnector] does not support addCW20Tokens()');
        };
        this.hasNetwork = () => {
            throw new Error('[LegacyExtensionConnector] does not support hasNetwork()');
        };
        this.addNetwork = () => {
            throw new Error('[LegacyExtensionConnector] does not support addNetwork()');
        };
        // ---------------------------------------------
        // internal
        // ---------------------------------------------
        this.recheckStates = async () => {
            if (this._extension.inTransactionProgress()) {
                return;
            }
            const infoResult = await this._extension.info();
            const connectResult = await this._extension.connect();
            if (connectResult.address && AccAddress.validate(connectResult.address)) {
                this._states.next({
                    type: WebExtensionStatus.READY,
                    network: infoResult,
                    focusedWalletAddress: connectResult.address,
                    wallets: [
                        {
                            name: '',
                            terraAddress: connectResult.address,
                            design: 'terra',
                        },
                    ],
                });
            }
            else {
                this._states.next({
                    type: WebExtensionStatus.READY,
                    network: infoResult,
                    focusedWalletAddress: undefined,
                    wallets: [],
                });
            }
        };
        this._states = new BehaviorSubject({
            type: WebExtensionStatus.INITIALIZING,
        });
        this._extension = createFixedExtension(identifier);
    }
    supportFeatures() {
        return supportFeatures;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL0B0ZXJyYS1tb25leS93YWxsZXQtcHJvdmlkZXIvbW9kdWxlcy9sZWdhY3ktZXh0ZW5zaW9uL0xlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBTUwsa0JBQWtCLEVBRWxCLG9CQUFvQixHQUNyQixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQW1CLE1BQU0sdUJBQXVCLENBQUM7QUFFcEUsT0FBTyxFQUFFLGVBQWUsRUFBd0MsTUFBTSxNQUFNLENBQUM7QUFDN0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxvQkFBb0IsRUFBa0IsTUFBTSx3QkFBd0IsQ0FBQztBQUU5RSxNQUFNLGVBQWUsR0FBZ0MsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFFdEUsTUFBTSxPQUFPLHdCQUF3QjtJQVVuQyxZQUFvQixVQUFrQjtRQUFsQixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBUDlCLGVBQVUsR0FBa0IsSUFBSSxDQUFDO1FBQ2pDLHVCQUFrQixHQUF3QixJQUFJLENBQUM7UUFjdkQsU0FBSSxHQUFHLENBQUMsVUFBa0IsRUFBRSxjQUE0QyxFQUFFLEVBQUU7WUFDMUUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7WUFDN0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxPQUFPO2lCQUNuQyxJQUFJLENBQ0gsTUFBTSxDQUNKLENBQUMsTUFBaUMsRUFBZ0MsRUFBRSxDQUNsRSxDQUFDLENBQUMsTUFBTSxDQUNYLENBQ0Y7aUJBQ0EsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRTdCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFF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ZWN0b3IsXG4gIFRlcnJhV2ViRXh0ZW5zaW9uRmVhdHVyZXMsXG4gIFdlYkV4dGVuc2lvblBvc3RQYXlsb2FkLFxuICBXZWJFeHRlbnNpb25TaWduUGF5bG9hZCxcbiAgV2ViRXh0ZW5zaW9uU3RhdGVzLFxuICBXZWJFeHRlbnNpb25TdGF0dXMsXG4gIFdlYkV4dGVuc2lvblR4UmVzdWx0LFxuICBXZWJFeHRlbnNpb25UeFN0YXR1cyxcbn0gZnJvbSAnQHRlcnJhLWRldi93ZWItZXh0ZW5zaW9uLWludGVyZmFjZSc7XG5pbXBvcnQgeyBBY2NBZGRyZXNzLCBDcmVhdGVUeE9wdGlvbnMgfSBmcm9tICdAdGVycmEtbW9uZXkvdGVycmEuanMnO1xuaW1wb3J0IHsgTmV0d29ya0luZm8gfSBmcm9tICdAdGVycmEtbW9uZXkvdXNlLXdhbGxldCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmVyLCBTdWJzY3JpYmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgY3JlYXRlRml4ZWRFeHRlbnNpb24sIEZpeGVkRXh0ZW5zaW9uIH0gZnJvbSAnLi9jcmVhdGVGaXhlZEV4dGVuc2lvbic7XG5cbmNvbnN0IHN1cHBvcnRGZWF0dXJlczogVGVycmFXZWJFeHRlbnNpb25GZWF0dXJlc1tdID0gWydwb3N0JywgJ3NpZ24nXTtcblxuZXhwb3J0IGNsYXNzIExlZ2FjeUV4dGVuc2lvbkNvbm5lY3RvciBpbXBsZW1lbnRzIFRlcnJhV2ViRXh0ZW5zaW9uQ29ubmVjdG9yIHtcbiAgcHJpdmF0ZSBfc3RhdGVzOiBCZWhhdmlvclN1YmplY3Q8V2ViRXh0ZW5zaW9uU3RhdGVzPjtcbiAgcHJpdmF0ZSBfZXh0ZW5zaW9uOiBGaXhlZEV4dGVuc2lvbjtcbiAgcHJpdmF0ZSBob3N0V2luZG93OiBXaW5kb3cgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBzdGF0ZXNTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiB8IG51bGwgPSBudWxsO1xuXG4gIHN1cHBvcnRGZWF0dXJlcygpIHtcbiAgICByZXR1cm4gc3VwcG9ydEZlYXR1cmVzO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpZGVudGlmaWVyOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9zdGF0ZXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFdlYkV4dGVuc2lvblN0YXRlcz4oe1xuICAgICAgdHlwZTogV2ViRXh0ZW5zaW9uU3RhdHVzLklOSVRJQUxJWklORyxcbiAgICB9KTtcblxuICAgIHRoaXMuX2V4dGVuc2lvbiA9IGNyZWF0ZUZpeGVkRXh0ZW5zaW9uKGlkZW50aWZpZXIpO1xuICB9XG5cbiAgb3BlbiA9IChob3N0V2luZG93OiBXaW5kb3csIHN0YXRlc09ic2VydmVyOiBPYnNlcnZlcjxXZWJFeHRlbnNpb25TdGF0ZXM+KSA9PiB7XG4gICAgdGhpcy5ob3N0V2luZG93ID0gaG9zdFdpbmRvdztcbiAgICB0aGlzLnN0YXRlc1N1YnNjcmlwdGlvbiA9IHRoaXMuX3N0YXRlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAoc3RhdGVzOiBXZWJFeHRlbnNpb25TdGF0ZXMgfCBudWxsKTogc3RhdGVzIGlzIFdlYkV4dGVuc2lvblN0YXRlcyA9PlxuICAgICAgICAgICAgISFzdGF0ZXMsXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKHN0YXRlc09ic2VydmVyKTtcblxuICAgIHRoaXMucmVmZXRjaFN0YXRlcygpO1xuICB9O1xuXG4gIGNsb3NlID0gKCkgPT4ge1xuICAgIHRoaXMuX2V4dGVuc2lvbi5kaXNjb25uZWN0KCk7XG4gIH07XG5cbiAgcmVxdWVzdEFwcHJvdmFsID0gKCkgPT4ge1xuICAgIHRoaXMucmVjaGVja1N0YXRlcygpO1xuICB9O1xuXG4gIHJlZmV0Y2hTdGF0ZXMgPSAoKSA9PiB7XG4gICAgdGhpcy5yZWNoZWNrU3RhdGVzKCk7XG4gIH07XG5cbiAgcG9zdCA9IChcbiAgICB0ZXJyYUFkZHJlc3M6IHN0cmluZyxcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICApOiBTdWJzY3JpYmFibGU8V2ViRXh0ZW5zaW9uVHhSZXN1bHQ8V2ViRXh0ZW5zaW9uUG9zdFBheWxvYWQ+PiA9PiB7XG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8XG4gICAgICBXZWJFeHRlbnNpb25UeFJlc3VsdDxXZWJFeHRlbnNpb25Qb3N0UGF5bG9hZD5cbiAgICA+KHtcbiAgICAgIHN0YXR1czogV2ViRXh0ZW5zaW9uVHhTdGF0dXMuUFJPR1JFU1MsXG4gICAgfSk7XG5cbiAgICB0aGlzLl9leHRlbnNpb25cbiAgICAgIC5wb3N0KHR4KVxuICAgICAgLnRoZW4oKHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgICAgIHN1YmplY3QubmV4dCh7XG4gICAgICAgICAgc3RhdHVzOiBXZWJFeHRlbnNpb25UeFN0YXR1cy5TVUNDRUVELFxuICAgICAgICAgIHBheWxvYWQ6IHBheWxvYWQucmVzdWx0LFxuICAgICAgICB9KTtcbiAgICAgICAgc3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHN1YmplY3QuZXJyb3IoZXJyb3IpKTtcblxuICAgIHJldHVybiBzdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9O1xuXG4gIHNpZ24gPSAoXG4gICAgdGVycmFBZGRyZXNzOiBzdHJpbmcsXG4gICAgdHg6IENyZWF0ZVR4T3B0aW9ucyxcbiAgKTogU3Vic2NyaWJhYmxlPFdlYkV4dGVuc2lvblR4UmVzdWx0PFdlYkV4dGVuc2lvblNpZ25QYXlsb2FkPj4gPT4ge1xuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFxuICAgICAgV2ViRXh0ZW5zaW9uVHhSZXN1bHQ8V2ViRXh0ZW5zaW9uU2lnblBheWxvYWQ+XG4gICAgPih7XG4gICAgICBzdGF0dXM6IFdlYkV4dGVuc2lvblR4U3RhdHVzLlBST0dSRVNTLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uXG4gICAgICAuc2lnbih0eClcbiAgICAgIC50aGVuKCh7IHBheWxvYWQgfSkgPT4ge1xuICAgICAgICBzdWJqZWN0Lm5leHQoe1xuICAgICAgICAgIHN0YXR1czogV2ViRXh0ZW5zaW9uVHhTdGF0dXMuU1VDQ0VFRCxcbiAgICAgICAgICBwYXlsb2FkOiBwYXlsb2FkLnJlc3VsdCxcbiAgICAgICAgfSk7XG4gICAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiBzdWJqZWN0LmVycm9yKGVycm9yKSk7XG5cbiAgICByZXR1cm4gc3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfTtcblxuICBzaWduQnl0ZXMgPSAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdbTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yXSBkb2VzIG5vdCBzdXBwb3J0IHNpZ25CeXRlcygpJyk7XG4gIH07XG5cbiAgaGFzQ1cyMFRva2VucyA9ICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnW0xlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvcl0gZG9lcyBub3Qgc3VwcG9ydCBoYXNDVzIwVG9rZW5zKCknLFxuICAgICk7XG4gIH07XG5cbiAgYWRkQ1cyMFRva2VucyA9ICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAnW0xlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvcl0gZG9lcyBub3Qgc3VwcG9ydCBhZGRDVzIwVG9rZW5zKCknLFxuICAgICk7XG4gIH07XG5cbiAgaGFzTmV0d29yayA9ICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1tMZWdhY3lFeHRlbnNpb25Db25uZWN0b3JdIGRvZXMgbm90IHN1cHBvcnQgaGFzTmV0d29yaygpJyk7XG4gIH07XG5cbiAgYWRkTmV0d29yayA9ICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1tMZWdhY3lFeHRlbnNpb25Db25uZWN0b3JdIGRvZXMgbm90IHN1cHBvcnQgYWRkTmV0d29yaygpJyk7XG4gIH07XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGludGVybmFsXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZWNoZWNrU3RhdGVzID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmICh0aGlzLl9leHRlbnNpb24uaW5UcmFuc2FjdGlvblByb2dyZXNzKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBpbmZvUmVzdWx0OiBOZXR3b3JrSW5mbyA9IGF3YWl0IHRoaXMuX2V4dGVuc2lvbi5pbmZvKCk7XG4gICAgY29uc3QgY29ubmVjdFJlc3VsdDogeyBhZGRyZXNzPzogc3RyaW5nIH0gPSBhd2FpdCB0aGlzLl9leHRlbnNpb24uY29ubmVjdCgpO1xuXG4gICAgaWYgKGNvbm5lY3RSZXN1bHQuYWRkcmVzcyAmJiBBY2NBZGRyZXNzLnZhbGlkYXRlKGNvbm5lY3RSZXN1bHQuYWRkcmVzcykpIHtcbiAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KHtcbiAgICAgICAgdHlwZTogV2ViRXh0ZW5zaW9uU3RhdHVzLlJFQURZLFxuICAgICAgICBuZXR3b3JrOiBpbmZvUmVzdWx0LFxuICAgICAgICBmb2N1c2VkV2FsbGV0QWRkcmVzczogY29ubmVjdFJlc3VsdC5hZGRyZXNzLFxuICAgICAgICB3YWxsZXRzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgbmFtZTogJycsXG4gICAgICAgICAgICB0ZXJyYUFkZHJlc3M6IGNvbm5lY3RSZXN1bHQuYWRkcmVzcyxcbiAgICAgICAgICAgIGRlc2lnbjogJ3RlcnJhJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KHtcbiAgICAgICAgdHlwZTogV2ViRXh0ZW5zaW9uU3RhdHVzLlJFQURZLFxuICAgICAgICBuZXR3b3JrOiBpbmZvUmVzdWx0LFxuICAgICAgICBmb2N1c2VkV2FsbGV0QWRkcmVzczogdW5kZWZpbmVkLFxuICAgICAgICB3YWxsZXRzOiBbXSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==