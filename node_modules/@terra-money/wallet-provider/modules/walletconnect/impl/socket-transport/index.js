import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString, } from '@walletconnect/utils';
import NetworkMonitor from './network';
// @ts-ignore
const WS = typeof global.WebSocket !== 'undefined' ? global.WebSocket : require('ws');
// -- SocketTransport ------------------------------------------------------ //
class SocketTransport {
    // -- constructor ----------------------------------------------------- //
    constructor(opts) {
        this.opts = opts;
        this._queue = [];
        this._events = [];
        this._subscriptions = [];
        // -- public ---------------------------------------------------------- //
        this.open = () => {
            this._socketCreate();
        };
        this.close = () => {
            this._socketClose();
        };
        this.send = (message, topic, silent) => {
            if (!topic || typeof topic !== 'string') {
                throw new Error('Missing or invalid topic field');
            }
            this._socketSend({
                topic: topic,
                type: 'pub',
                payload: message,
                silent: !!silent,
            });
        };
        this.subscribe = (topic) => {
            this._socketSend({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            });
        };
        this.on = (event, callback) => {
            this._events.push({ event, callback });
        };
        // -- private ---------------------------------------------------------- //
        this._socketCreate = () => {
            if (this._nextSocket) {
                return;
            }
            const url = getWebSocketUrl(this._url, this._protocol, this._version);
            this._nextSocket = new WS(url);
            if (!this._nextSocket) {
                throw new Error('Failed to create socket');
            }
            this._nextSocket.onmessage = (event) => this._socketReceive(event);
            this._nextSocket.onopen = () => this._socketOpen();
            this._nextSocket.onerror = (event) => this._socketError(event);
            this._nextSocket.onclose = () => {
                this._nextSocket = null;
                setTimeout(this._socketCreate, 500);
            };
        };
        this._socketOpen = () => {
            this._socketClose();
            this._socket = this._nextSocket;
            this._nextSocket = null;
            this._queueSubscriptions();
            this._pushQueue();
        };
        this._socketClose = () => {
            if (this._socket) {
                this._socket.onclose = () => {
                    // empty
                };
                this._socket.close();
            }
        };
        this._socketSend = (socketMessage) => {
            const message = JSON.stringify(socketMessage);
            if (this._socket && this._socket.readyState === 1) {
                this._socket.send(message);
            }
            else {
                this._setToQueue(socketMessage);
                this._socketCreate();
            }
        };
        this._socketReceive = async (event) => {
            let socketMessage;
            try {
                socketMessage = JSON.parse(event.data);
            }
            catch (error) {
                return;
            }
            this._socketSend({
                topic: socketMessage.topic,
                type: 'ack',
                payload: '',
                silent: true,
            });
            if (this._socket && this._socket.readyState === 1) {
                const events = this._events.filter((itemEvent) => itemEvent.event === 'message');
                if (events && events.length) {
                    events.forEach((itemEvent) => itemEvent.callback(socketMessage));
                }
            }
        };
        this._socketError = (e) => {
            const events = this._events.filter((event) => event.event === 'error');
            if (events && events.length) {
                events.forEach((event) => event.callback(e));
            }
        };
        this._queueSubscriptions = () => {
            const subscriptions = this._subscriptions;
            subscriptions.forEach((topic) => this._queue.push({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            }));
            this._subscriptions = this.opts.subscriptions || [];
        };
        this._setToQueue = (socketMessage) => {
            this._queue.push(socketMessage);
        };
        this._pushQueue = () => {
            const queue = this._queue;
            queue.forEach((socketMessage) => this._socketSend(socketMessage));
            this._queue = [];
        };
        this._protocol = opts.protocol;
        this._version = opts.version;
        this._url = '';
        this._netMonitor = null;
        this._socket = null;
        this._nextSocket = null;
        this._subscriptions = opts.subscriptions || [];
        this._netMonitor = opts.netMonitor || new NetworkMonitor();
        if (!opts.url || typeof opts.url !== 'string') {
            throw new Error('Missing or invalid WebSocket url');
        }
        this._url = opts.url;
        this._netMonitor.on('online', () => this._socketCreate());
    }
    set readyState(value) {
        // empty
    }
    get readyState() {
        return this._socket ? this._socket.readyState : -1;
    }
    set connecting(value) {
        // empty
    }
    get connecting() {
        return this.readyState === 0;
    }
    set connected(value) {
        // empty
    }
    get connected() {
        return this.readyState === 1;
    }
    set closing(value) {
        // empty
    }
    get closing() {
        return this.readyState === 2;
    }
    set closed(value) {
        // empty
    }
    get closed() {
        return this.readyState === 3;
    }
}
function getWebSocketUrl(webUrl, protocol, version) {
    var _a, _b;
    const url = webUrl.startsWith('https')
        ? webUrl.replace('https', 'wss')
        : webUrl.startsWith('http')
            ? webUrl.replace('http', 'ws')
            : webUrl;
    const splitUrl = url.split('?');
    const params = isBrowser()
        ? {
            protocol,
            version,
            env: 'browser',
            host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || '',
        }
        : {
            protocol,
            version,
            env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || '',
        };
    const queryString = appendToQueryString(getQueryString(splitUrl[1] || ''), params);
    return splitUrl[0] + '?' + queryString;
}
export default SocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvQHRlcnJhLW1vbmV5L3dhbGxldC1wcm92aWRlci9tb2R1bGVzL3dhbGxldGNvbm5lY3QvaW1wbC9zb2NrZXQtdHJhbnNwb3J0L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLE9BQU8sRUFDTCxTQUFTLEVBQ1QsV0FBVyxFQUNYLGNBQWMsRUFDZCxTQUFTLEVBQ1QsbUJBQW1CLEdBQ3BCLE1BQU0sc0JBQXNCLENBQUM7QUFFOUIsT0FBTyxjQUFjLE1BQU0sV0FBVyxDQUFDO0FBRXZDLGFBQWE7QUFDYixNQUFNLEVBQUUsR0FDTixPQUFPLE1BQU0sQ0FBQyxTQUFTLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFN0UsK0VBQStFO0FBRS9FLE1BQU0sZUFBZTtJQVduQiwwRUFBMEU7SUFFMUUsWUFBb0IsSUFBNkI7UUFBN0IsU0FBSSxHQUFKLElBQUksQ0FBeUI7UUFOekMsV0FBTSxHQUFxQixFQUFFLENBQUM7UUFDOUIsWUFBTyxHQUFzQixFQUFFLENBQUM7UUFDaEMsbUJBQWMsR0FBYSxFQUFFLENBQUM7UUErRHRDLDBFQUEwRTtRQUVuRSxTQUFJLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFFSyxVQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QixDQUFDLENBQUM7UUFFSyxTQUFJLEdBQUcsQ0FBQyxPQUFlLEVBQUUsS0FBYyxFQUFFLE1BQWdCLEVBQVEsRUFBRTtZQUN4RSxJQUFJLENBQUMsS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtnQkFDdkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2FBQ25EO1lBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFDZixLQUFLLEVBQUUsS0FBSztnQkFDWixJQUFJLEVBQUUsS0FBSztnQkFDWCxPQUFPLEVBQUUsT0FBTztnQkFDaEIsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNO2FBQ2pCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUVLLGNBQVMsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFO1lBQ25DLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsS0FBSyxFQUFFLEtBQUs7Z0JBQ1osSUFBSSxFQUFFLEtBQUs7Z0JBQ1gsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsTUFBTSxFQUFFLElBQUk7YUFDYixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUM7UUFFSyxPQUFFLEdBQUcsQ0FBQyxLQUFhLEVBQUUsUUFBZ0MsRUFBRSxFQUFFO1lBQzlELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDekMsQ0FBQyxDQUFDO1FBRUYsMkVBQTJFO1FBRW5FLGtCQUFhLEdBQUcsR0FBRyxFQUFFO1lBQzNCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDcEIsT0FBTzthQUNSO1lBRUQsTUFBTSxHQUFHLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFdEUsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUUvQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO2FBQzVDO1lBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxLQUFtQixFQUFFLEVBQUUsQ0FDbkQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUU3QixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFdEUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO2dCQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztnQkFDeEIsVUFBVSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDO1FBRU0sZ0JBQVcsR0FBRyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUNoQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztZQUN4QixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDO1FBRU0saUJBQVksR0FBRyxHQUFHLEVBQUU7WUFDMUIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUU7b0JBQzFCLFFBQVE7Z0JBQ1YsQ0FBQyxDQUFDO2dCQUNGLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDdEI7UUFDSCxDQUFDLENBQUM7UUFFTSxnQkFBVyxHQUFHLENBQUMsYUFBNkIsRUFBRSxFQUFFO1lBQ3RELE1BQU0sT0FBTyxHQUFXLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFdEQsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxLQUFLLENBQUMsRUFBRTtnQkFDakQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDNUI7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQ3RCO1FBQ0gsQ0FBQyxDQUFDO1FBRU0sbUJBQWMsR0FBRyxLQUFLLEVBQUUsS0FBbUIsRUFBRSxFQUFFO1lBQ3JELElBQUksYUFBNkIsQ0FBQztZQUVsQyxJQUFJO2dCQUNGLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4QztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLE9BQU87YUFDUjtZQUVELElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLO2dCQUMxQixJQUFJLEVBQUUsS0FBSztnQkFDWCxPQUFPLEVBQUUsRUFBRTtnQkFDWCxNQUFNLEVBQUUsSUFBSTthQUNiLENBQUMsQ0FBQztZQUVILElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsS0FBSyxDQUFDLEVBQUU7Z0JBQ2pELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUNoQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQzdDLENBQUM7Z0JBQ0YsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRTtvQkFDM0IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO2lCQUNsRTthQUNGO1FBQ0gsQ0FBQyxDQUFDO1FBRU0saUJBQVksR0FBRyxDQUFDLENBQVEsRUFBRSxFQUFFO1lBQ2xDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZFLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEVBQUU7Z0JBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM5QztRQUNILENBQUMsQ0FBQztRQUVNLHdCQUFtQixHQUFHLEdBQUcsRUFBRTtZQUNqQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBRTFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDZixLQUFLLEVBQUUsS0FBSztnQkFDWixJQUFJLEVBQUUsS0FBSztnQkFDWCxPQUFPLEVBQUUsRUFBRTtnQkFDWCxNQUFNLEVBQUUsSUFBSTthQUNiLENBQUMsQ0FDSCxDQUFDO1lBRUYsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUM7UUFDdEQsQ0FBQyxDQUFDO1FBRU0sZ0JBQVcsR0FBRyxDQUFDLGFBQTZCLEVBQUUsRUFBRTtZQUN0RCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUM7UUFFTSxlQUFVLEdBQUcsR0FBRyxFQUFFO1lBQ3hCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFFMUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQTZCLEVBQUUsRUFBRSxDQUM5QyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUNoQyxDQUFDO1lBRUYsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbkIsQ0FBQyxDQUFDO1FBbE5BLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBRTNELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLE9BQU8sSUFBSSxDQUFDLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDN0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1NBQ3JEO1FBRUQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBRXJCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsSUFBSSxVQUFVLENBQUMsS0FBSztRQUNsQixRQUFRO0lBQ1YsQ0FBQztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxJQUFJLFVBQVUsQ0FBQyxLQUFLO1FBQ2xCLFFBQVE7SUFDVixDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsVUFBVSxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxTQUFTLENBQUMsS0FBSztRQUNqQixRQUFRO0lBQ1YsQ0FBQztJQUVELElBQUksU0FBUztRQUNYLE9BQU8sSUFBSSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksT0FBTyxDQUFDLEtBQUs7UUFDZixRQUFRO0lBQ1YsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksTUFBTSxDQUFDLEtBQUs7UUFDZCxRQUFRO0lBQ1YsQ0FBQztJQUVELElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLFVBQVUsS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztDQTJKRjtBQUVELFNBQVMsZUFBZSxDQUN0QixNQUFjLEVBQ2QsUUFBZ0IsRUFDaEIsT0FBZTs7SUFFZixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztRQUNwQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQztZQUMzQixDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDO1lBQzlCLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDWCxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLE1BQU0sTUFBTSxHQUFHLFNBQVMsRUFBRTtRQUN4QixDQUFDLENBQUM7WUFDRSxRQUFRO1lBQ1IsT0FBTztZQUNQLEdBQUcsRUFBRSxTQUFTO1lBQ2QsSUFBSSxFQUFFLENBQUEsTUFBQSxXQUFXLEVBQUUsMENBQUUsSUFBSSxLQUFJLEVBQUU7U0FDaEM7UUFDSCxDQUFDLENBQUM7WUFDRSxRQUFRO1lBQ1IsT0FBTztZQUNQLEdBQUcsRUFBRSxDQUFBLE1BQUEsU0FBUyxFQUFFLDBDQUFFLElBQUksS0FBSSxFQUFFO1NBQzdCLENBQUM7SUFDTixNQUFNLFdBQVcsR0FBRyxtQkFBbUIsQ0FDckMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFDakMsTUFBTSxDQUNQLENBQUM7SUFDRixPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsV0FBVyxDQUFDO0FBQ3pDLENBQUM7QUFFRCxlQUFlLGVBQWUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElTb2NrZXRNZXNzYWdlLFxuICBJVHJhbnNwb3J0RXZlbnQsXG4gIElOZXR3b3JrTW9uaXRvcixcbiAgSVRyYW5zcG9ydExpYixcbiAgSVNvY2tldFRyYW5zcG9ydE9wdGlvbnMsXG59IGZyb20gJ0B3YWxsZXRjb25uZWN0L3R5cGVzJztcbmltcG9ydCB7XG4gIGlzQnJvd3NlcixcbiAgZ2V0TG9jYXRpb24sXG4gIGdldFF1ZXJ5U3RyaW5nLFxuICBkZXRlY3RFbnYsXG4gIGFwcGVuZFRvUXVlcnlTdHJpbmcsXG59IGZyb20gJ0B3YWxsZXRjb25uZWN0L3V0aWxzJztcblxuaW1wb3J0IE5ldHdvcmtNb25pdG9yIGZyb20gJy4vbmV0d29yayc7XG5cbi8vIEB0cy1pZ25vcmVcbmNvbnN0IFdTID1cbiAgdHlwZW9mIGdsb2JhbC5XZWJTb2NrZXQgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsLldlYlNvY2tldCA6IHJlcXVpcmUoJ3dzJyk7XG5cbi8vIC0tIFNvY2tldFRyYW5zcG9ydCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuY2xhc3MgU29ja2V0VHJhbnNwb3J0IGltcGxlbWVudHMgSVRyYW5zcG9ydExpYiB7XG4gIHByaXZhdGUgX3Byb3RvY29sOiBzdHJpbmc7XG4gIHByaXZhdGUgX3ZlcnNpb246IG51bWJlcjtcbiAgcHJpdmF0ZSBfdXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgX25ldE1vbml0b3I6IElOZXR3b3JrTW9uaXRvciB8IG51bGw7XG4gIHByaXZhdGUgX3NvY2tldDogV2ViU29ja2V0IHwgbnVsbDtcbiAgcHJpdmF0ZSBfbmV4dFNvY2tldDogV2ViU29ja2V0IHwgbnVsbDtcbiAgcHJpdmF0ZSBfcXVldWU6IElTb2NrZXRNZXNzYWdlW10gPSBbXTtcbiAgcHJpdmF0ZSBfZXZlbnRzOiBJVHJhbnNwb3J0RXZlbnRbXSA9IFtdO1xuICBwcml2YXRlIF9zdWJzY3JpcHRpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gIC8vIC0tIGNvbnN0cnVjdG9yIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vXG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHRzOiBJU29ja2V0VHJhbnNwb3J0T3B0aW9ucykge1xuICAgIHRoaXMuX3Byb3RvY29sID0gb3B0cy5wcm90b2NvbDtcbiAgICB0aGlzLl92ZXJzaW9uID0gb3B0cy52ZXJzaW9uO1xuICAgIHRoaXMuX3VybCA9ICcnO1xuICAgIHRoaXMuX25ldE1vbml0b3IgPSBudWxsO1xuICAgIHRoaXMuX3NvY2tldCA9IG51bGw7XG4gICAgdGhpcy5fbmV4dFNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IG9wdHMuc3Vic2NyaXB0aW9ucyB8fCBbXTtcbiAgICB0aGlzLl9uZXRNb25pdG9yID0gb3B0cy5uZXRNb25pdG9yIHx8IG5ldyBOZXR3b3JrTW9uaXRvcigpO1xuXG4gICAgaWYgKCFvcHRzLnVybCB8fCB0eXBlb2Ygb3B0cy51cmwgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3Npbmcgb3IgaW52YWxpZCBXZWJTb2NrZXQgdXJsJyk7XG4gICAgfVxuXG4gICAgdGhpcy5fdXJsID0gb3B0cy51cmw7XG5cbiAgICB0aGlzLl9uZXRNb25pdG9yLm9uKCdvbmxpbmUnLCAoKSA9PiB0aGlzLl9zb2NrZXRDcmVhdGUoKSk7XG4gIH1cblxuICBzZXQgcmVhZHlTdGF0ZSh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgcmVhZHlTdGF0ZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9zb2NrZXQgPyB0aGlzLl9zb2NrZXQucmVhZHlTdGF0ZSA6IC0xO1xuICB9XG5cbiAgc2V0IGNvbm5lY3RpbmcodmFsdWUpIHtcbiAgICAvLyBlbXB0eVxuICB9XG5cbiAgZ2V0IGNvbm5lY3RpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHlTdGF0ZSA9PT0gMDtcbiAgfVxuXG4gIHNldCBjb25uZWN0ZWQodmFsdWUpIHtcbiAgICAvLyBlbXB0eVxuICB9XG5cbiAgZ2V0IGNvbm5lY3RlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAxO1xuICB9XG5cbiAgc2V0IGNsb3NpbmcodmFsdWUpIHtcbiAgICAvLyBlbXB0eVxuICB9XG5cbiAgZ2V0IGNsb3NpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHlTdGF0ZSA9PT0gMjtcbiAgfVxuXG4gIHNldCBjbG9zZWQodmFsdWUpIHtcbiAgICAvLyBlbXB0eVxuICB9XG5cbiAgZ2V0IGNsb3NlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAzO1xuICB9XG5cbiAgLy8gLS0gcHVibGljIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuICBwdWJsaWMgb3BlbiA9ICgpID0+IHtcbiAgICB0aGlzLl9zb2NrZXRDcmVhdGUoKTtcbiAgfTtcblxuICBwdWJsaWMgY2xvc2UgPSAoKSA9PiB7XG4gICAgdGhpcy5fc29ja2V0Q2xvc2UoKTtcbiAgfTtcblxuICBwdWJsaWMgc2VuZCA9IChtZXNzYWdlOiBzdHJpbmcsIHRvcGljPzogc3RyaW5nLCBzaWxlbnQ/OiBib29sZWFuKTogdm9pZCA9PiB7XG4gICAgaWYgKCF0b3BpYyB8fCB0eXBlb2YgdG9waWMgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3Npbmcgb3IgaW52YWxpZCB0b3BpYyBmaWVsZCcpO1xuICAgIH1cblxuICAgIHRoaXMuX3NvY2tldFNlbmQoe1xuICAgICAgdG9waWM6IHRvcGljLFxuICAgICAgdHlwZTogJ3B1YicsXG4gICAgICBwYXlsb2FkOiBtZXNzYWdlLFxuICAgICAgc2lsZW50OiAhIXNpbGVudCxcbiAgICB9KTtcbiAgfTtcblxuICBwdWJsaWMgc3Vic2NyaWJlID0gKHRvcGljOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLl9zb2NrZXRTZW5kKHtcbiAgICAgIHRvcGljOiB0b3BpYyxcbiAgICAgIHR5cGU6ICdzdWInLFxuICAgICAgcGF5bG9hZDogJycsXG4gICAgICBzaWxlbnQ6IHRydWUsXG4gICAgfSk7XG4gIH07XG5cbiAgcHVibGljIG9uID0gKGV2ZW50OiBzdHJpbmcsIGNhbGxiYWNrOiAocGF5bG9hZDogYW55KSA9PiB2b2lkKSA9PiB7XG4gICAgdGhpcy5fZXZlbnRzLnB1c2goeyBldmVudCwgY2FsbGJhY2sgfSk7XG4gIH07XG5cbiAgLy8gLS0gcHJpdmF0ZSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vXG5cbiAgcHJpdmF0ZSBfc29ja2V0Q3JlYXRlID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLl9uZXh0U29ja2V0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gZ2V0V2ViU29ja2V0VXJsKHRoaXMuX3VybCwgdGhpcy5fcHJvdG9jb2wsIHRoaXMuX3ZlcnNpb24pO1xuXG4gICAgdGhpcy5fbmV4dFNvY2tldCA9IG5ldyBXUyh1cmwpO1xuXG4gICAgaWYgKCF0aGlzLl9uZXh0U29ja2V0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgc29ja2V0Jyk7XG4gICAgfVxuXG4gICAgdGhpcy5fbmV4dFNvY2tldC5vbm1lc3NhZ2UgPSAoZXZlbnQ6IE1lc3NhZ2VFdmVudCkgPT5cbiAgICAgIHRoaXMuX3NvY2tldFJlY2VpdmUoZXZlbnQpO1xuXG4gICAgdGhpcy5fbmV4dFNvY2tldC5vbm9wZW4gPSAoKSA9PiB0aGlzLl9zb2NrZXRPcGVuKCk7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9uZXJyb3IgPSAoZXZlbnQ6IEV2ZW50KSA9PiB0aGlzLl9zb2NrZXRFcnJvcihldmVudCk7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9uY2xvc2UgPSAoKSA9PiB7XG4gICAgICB0aGlzLl9uZXh0U29ja2V0ID0gbnVsbDtcbiAgICAgIHNldFRpbWVvdXQodGhpcy5fc29ja2V0Q3JlYXRlLCA1MDApO1xuICAgIH07XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0T3BlbiA9ICgpID0+IHtcbiAgICB0aGlzLl9zb2NrZXRDbG9zZSgpO1xuICAgIHRoaXMuX3NvY2tldCA9IHRoaXMuX25leHRTb2NrZXQ7XG4gICAgdGhpcy5fbmV4dFNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5fcXVldWVTdWJzY3JpcHRpb25zKCk7XG4gICAgdGhpcy5fcHVzaFF1ZXVlKCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0Q2xvc2UgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuX3NvY2tldCkge1xuICAgICAgdGhpcy5fc29ja2V0Lm9uY2xvc2UgPSAoKSA9PiB7XG4gICAgICAgIC8vIGVtcHR5XG4gICAgICB9O1xuICAgICAgdGhpcy5fc29ja2V0LmNsb3NlKCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgX3NvY2tldFNlbmQgPSAoc29ja2V0TWVzc2FnZTogSVNvY2tldE1lc3NhZ2UpID0+IHtcbiAgICBjb25zdCBtZXNzYWdlOiBzdHJpbmcgPSBKU09OLnN0cmluZ2lmeShzb2NrZXRNZXNzYWdlKTtcblxuICAgIGlmICh0aGlzLl9zb2NrZXQgJiYgdGhpcy5fc29ja2V0LnJlYWR5U3RhdGUgPT09IDEpIHtcbiAgICAgIHRoaXMuX3NvY2tldC5zZW5kKG1lc3NhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9zZXRUb1F1ZXVlKHNvY2tldE1lc3NhZ2UpO1xuICAgICAgdGhpcy5fc29ja2V0Q3JlYXRlKCk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgX3NvY2tldFJlY2VpdmUgPSBhc3luYyAoZXZlbnQ6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgIGxldCBzb2NrZXRNZXNzYWdlOiBJU29ja2V0TWVzc2FnZTtcblxuICAgIHRyeSB7XG4gICAgICBzb2NrZXRNZXNzYWdlID0gSlNPTi5wYXJzZShldmVudC5kYXRhKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX3NvY2tldFNlbmQoe1xuICAgICAgdG9waWM6IHNvY2tldE1lc3NhZ2UudG9waWMsXG4gICAgICB0eXBlOiAnYWNrJyxcbiAgICAgIHBheWxvYWQ6ICcnLFxuICAgICAgc2lsZW50OiB0cnVlLFxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuX3NvY2tldCAmJiB0aGlzLl9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgY29uc3QgZXZlbnRzID0gdGhpcy5fZXZlbnRzLmZpbHRlcihcbiAgICAgICAgKGl0ZW1FdmVudCkgPT4gaXRlbUV2ZW50LmV2ZW50ID09PSAnbWVzc2FnZScsXG4gICAgICApO1xuICAgICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7XG4gICAgICAgIGV2ZW50cy5mb3JFYWNoKChpdGVtRXZlbnQpID0+IGl0ZW1FdmVudC5jYWxsYmFjayhzb2NrZXRNZXNzYWdlKSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgX3NvY2tldEVycm9yID0gKGU6IEV2ZW50KSA9PiB7XG4gICAgY29uc3QgZXZlbnRzID0gdGhpcy5fZXZlbnRzLmZpbHRlcigoZXZlbnQpID0+IGV2ZW50LmV2ZW50ID09PSAnZXJyb3InKTtcbiAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT4gZXZlbnQuY2FsbGJhY2soZSkpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIF9xdWV1ZVN1YnNjcmlwdGlvbnMgPSAoKSA9PiB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9ucyA9IHRoaXMuX3N1YnNjcmlwdGlvbnM7XG5cbiAgICBzdWJzY3JpcHRpb25zLmZvckVhY2goKHRvcGljOiBzdHJpbmcpID0+XG4gICAgICB0aGlzLl9xdWV1ZS5wdXNoKHtcbiAgICAgICAgdG9waWM6IHRvcGljLFxuICAgICAgICB0eXBlOiAnc3ViJyxcbiAgICAgICAgcGF5bG9hZDogJycsXG4gICAgICAgIHNpbGVudDogdHJ1ZSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gdGhpcy5vcHRzLnN1YnNjcmlwdGlvbnMgfHwgW107XG4gIH07XG5cbiAgcHJpdmF0ZSBfc2V0VG9RdWV1ZSA9IChzb2NrZXRNZXNzYWdlOiBJU29ja2V0TWVzc2FnZSkgPT4ge1xuICAgIHRoaXMuX3F1ZXVlLnB1c2goc29ja2V0TWVzc2FnZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBfcHVzaFF1ZXVlID0gKCkgPT4ge1xuICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5fcXVldWU7XG5cbiAgICBxdWV1ZS5mb3JFYWNoKChzb2NrZXRNZXNzYWdlOiBJU29ja2V0TWVzc2FnZSkgPT5cbiAgICAgIHRoaXMuX3NvY2tldFNlbmQoc29ja2V0TWVzc2FnZSksXG4gICAgKTtcblxuICAgIHRoaXMuX3F1ZXVlID0gW107XG4gIH07XG59XG5cbmZ1bmN0aW9uIGdldFdlYlNvY2tldFVybChcbiAgd2ViVXJsOiBzdHJpbmcsXG4gIHByb3RvY29sOiBzdHJpbmcsXG4gIHZlcnNpb246IG51bWJlcixcbik6IHN0cmluZyB7XG4gIGNvbnN0IHVybCA9IHdlYlVybC5zdGFydHNXaXRoKCdodHRwcycpXG4gICAgPyB3ZWJVcmwucmVwbGFjZSgnaHR0cHMnLCAnd3NzJylcbiAgICA6IHdlYlVybC5zdGFydHNXaXRoKCdodHRwJylcbiAgICA/IHdlYlVybC5yZXBsYWNlKCdodHRwJywgJ3dzJylcbiAgICA6IHdlYlVybDtcbiAgY29uc3Qgc3BsaXRVcmwgPSB1cmwuc3BsaXQoJz8nKTtcbiAgY29uc3QgcGFyYW1zID0gaXNCcm93c2VyKClcbiAgICA/IHtcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgIHZlcnNpb24sXG4gICAgICAgIGVudjogJ2Jyb3dzZXInLFxuICAgICAgICBob3N0OiBnZXRMb2NhdGlvbigpPy5ob3N0IHx8ICcnLFxuICAgICAgfVxuICAgIDoge1xuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgZW52OiBkZXRlY3RFbnYoKT8ubmFtZSB8fCAnJyxcbiAgICAgIH07XG4gIGNvbnN0IHF1ZXJ5U3RyaW5nID0gYXBwZW5kVG9RdWVyeVN0cmluZyhcbiAgICBnZXRRdWVyeVN0cmluZyhzcGxpdFVybFsxXSB8fCAnJyksXG4gICAgcGFyYW1zLFxuICApO1xuICByZXR1cm4gc3BsaXRVcmxbMF0gKyAnPycgKyBxdWVyeVN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgU29ja2V0VHJhbnNwb3J0O1xuIl19