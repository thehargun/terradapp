{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar readable_stream_1 = require(\"readable-stream\");\n\nvar noop = function () {\n  return undefined;\n};\n\nvar PostMessageStream =\n/** @class */\nfunction (_super) {\n  __extends(PostMessageStream, _super);\n\n  function PostMessageStream(_a) {\n    var name = _a.name,\n        target = _a.target,\n        targetWindow = _a.targetWindow;\n\n    var _this = _super.call(this, {\n      objectMode: true\n    }) || this;\n\n    _this._name = name;\n    _this._target = target;\n    _this._targetWindow = targetWindow || window;\n    _this._origin = targetWindow ? '*' : location.origin; // initialization flags\n\n    _this._init = false;\n    _this._haveSyn = false;\n    _this._onMessage = _this._onMessage.bind(_this);\n    window.addEventListener('message', _this._onMessage, false); // send syncorization message\n\n    _this._write('SYN', null, noop);\n\n    _this.cork();\n\n    return _this;\n  }\n\n  PostMessageStream.prototype._destroy = function () {\n    // console.log('PostMessageStream: destroy');\n    window.removeEventListener('message', this._onMessage, false);\n  };\n\n  PostMessageStream.prototype._onMessage = function (event) {\n    var msg = event.data; // validate message\n\n    if (this._origin !== '*' && event.origin !== this._origin) return;\n    if (event.source !== this._targetWindow) return;\n    if (typeof msg !== 'object') return;\n    if (msg.target !== this._name) return;\n    if (!msg.data) return;\n\n    if (!this._init) {\n      if (msg.data === 'SYN') {\n        this._haveSyn = true;\n\n        this._write('ACK', null, noop);\n      } else if (msg.data === 'ACK') {\n        this._init = true;\n\n        if (!this._haveSyn) {\n          this._write('ACK', null, noop);\n        }\n\n        this.uncork();\n      }\n    } else {\n      // forward message\n      try {\n        this.push(msg.data);\n      } catch (err) {\n        this.emit('error', err);\n      }\n    }\n  };\n\n  PostMessageStream.prototype._read = function () {\n    return undefined;\n  };\n\n  PostMessageStream.prototype._write = function (data, _encoding, cb) {\n    var message = {\n      target: this._target,\n      data: data\n    };\n\n    this._targetWindow.postMessage(message, this._origin);\n\n    cb(null);\n  };\n\n  return PostMessageStream;\n}(readable_stream_1.Duplex);\n\nexports.default = PostMessageStream;","map":{"version":3,"sources":["../../src/extension/PostMessageStream.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar readable_stream_1 = require(\"readable-stream\");\nvar noop = function () {\n    return undefined;\n};\nvar PostMessageStream = /** @class */ (function (_super) {\n    __extends(PostMessageStream, _super);\n    function PostMessageStream(_a) {\n        var name = _a.name, target = _a.target, targetWindow = _a.targetWindow;\n        var _this = _super.call(this, { objectMode: true }) || this;\n        _this._name = name;\n        _this._target = target;\n        _this._targetWindow = targetWindow || window;\n        _this._origin = targetWindow ? '*' : location.origin;\n        // initialization flags\n        _this._init = false;\n        _this._haveSyn = false;\n        _this._onMessage = _this._onMessage.bind(_this);\n        window.addEventListener('message', _this._onMessage, false);\n        // send syncorization message\n        _this._write('SYN', null, noop);\n        _this.cork();\n        return _this;\n    }\n    PostMessageStream.prototype._destroy = function () {\n        // console.log('PostMessageStream: destroy');\n        window.removeEventListener('message', this._onMessage, false);\n    };\n    PostMessageStream.prototype._onMessage = function (event) {\n        var msg = event.data;\n        // validate message\n        if (this._origin !== '*' && event.origin !== this._origin)\n            return;\n        if (event.source !== this._targetWindow)\n            return;\n        if (typeof msg !== 'object')\n            return;\n        if (msg.target !== this._name)\n            return;\n        if (!msg.data)\n            return;\n        if (!this._init) {\n            if (msg.data === 'SYN') {\n                this._haveSyn = true;\n                this._write('ACK', null, noop);\n            }\n            else if (msg.data === 'ACK') {\n                this._init = true;\n                if (!this._haveSyn) {\n                    this._write('ACK', null, noop);\n                }\n                this.uncork();\n            }\n        }\n        else {\n            // forward message\n            try {\n                this.push(msg.data);\n            }\n            catch (err) {\n                this.emit('error', err);\n            }\n        }\n    };\n    PostMessageStream.prototype._read = function () {\n        return undefined;\n    };\n    PostMessageStream.prototype._write = function (data, _encoding, cb) {\n        var message = {\n            target: this._target,\n            data: data,\n        };\n        this._targetWindow.postMessage(message, this._origin);\n        cb(null);\n    };\n    return PostMessageStream;\n}(readable_stream_1.Duplex));\nexports.default = PostMessageStream;\n//# sourceMappingURL=PostMessageStream.js.map"]},"metadata":{},"sourceType":"script"}